---
title: "Modeling biodiversity metrics"
author: "Alex Baecher & Ed Basham"
date: "12/18/2020"
output:
  pdf_document: default
---

# Preparing workspace
## Calling libraries
```{r load packages}
# Set session mirror for knitting
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org"
       options(repos=r)})

# my package-loading script
URL <- "https://raw.githubusercontent.com/slamander/load_packages/main/prepare_libraries.R"

# take that script, parse it, and load it to our environment
eval(parse(text = RCurl::getURL(URL, ssl.verifypeer = F)), envir = .GlobalEnv)

# add packages to be used here
packages <-  c("lme4","AICcmodavg","glmmTMB","TMB","tidyverse","readr","scales",
               "formula.tools","sjPlot","ggpubr","scales","Hmisc","visreg","bbmle")

# run function:
prepare_libraries(packages)
```

## Loading data
```{r loading data}
# weights <- c(bin_weight, spatial_effort_unit, spatial_effort, temporal_effort_unit, metric_effort, temporal_effort_at_each_height, data_quality)

dat <- read_csv("data/stripped_data/final/data_joined.csv") %>%
  dplyr::filter(taxa != "All mammals") %>%
  dplyr::filter(taxa != "Primates") %>%
  dplyr::mutate(weight = spatial_rank + temporal_bredth_rank + temporal_resolution_rank,
                taxa = as.factor(taxa),
                taxa_order = factor(taxa, levels = c("Birds","Bats","Small mammals","Amphibians")),
                elevation = as.numeric(elevation),
                scaled_met = as.numeric(rescale(corrected_biodiversity_metric_value, to = c(1e-05, 0.99999))),
                link = as.factor(link), 
                method = as.factor(method), 
                treatment = as.factor(treatment),
                continent = as.factor(continent),
                biodiversity_metric = as.factor(biodiversity_metric), 
                season = as.factor(season), 
                forest_type = as.factor(forest_type),  
                mean_strata_height_p = as.numeric(mean_strata_height_p)) %>%
  dplyr::select(link, study_id.x, method, taxa, bin_weight, continent, biodiversity_metric, taxa_order,
                treatment, season, forest_type, elevation, canopy_height, latitude, longitude, 
                scaled_met, strata = mean_strata_height_p, weight) 

abund <- dat %>%
  dplyr::filter(biodiversity_metric == "abundance")

rich <- dat %>% 
  dplyr::filter(biodiversity_metric == "richness")
```

# Modeling species richness
## Richness GLMs
```{r Modeling species richness: GLMs, message=FALSE, warning=FALSE}
mods_rich <- list()

# strata only models 
mods_rich[[1]]  <- glmmTMB(scaled_met ~ 1 +                                                (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[2]]  <- glmmTMB(scaled_met ~ strata +                                           (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[3]]  <- glmmTMB(scaled_met ~ poly(strata, 2) +                                  (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[4]]  <- glmmTMB(scaled_met ~ poly(strata, 3) +                                  (strata|link), family = beta_family(link = "logit"), data = rich)
# strata and taxa
mods_rich[[5]]  <- glmmTMB(scaled_met ~ strata + taxa +                                    (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[6]]  <- glmmTMB(scaled_met ~ poly(strata, 2) + taxa +                           (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[7]]  <- glmmTMB(scaled_met ~ poly(strata, 3) + taxa +                           (strata|link), family = beta_family(link = "logit"), data = rich)
# strata and continent 
mods_rich[[8]]  <- glmmTMB(scaled_met ~ strata + continent +                               (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[9]]  <- glmmTMB(scaled_met ~ poly(strata, 2) + continent +                      (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[10]] <- glmmTMB(scaled_met ~ poly(strata, 3) + continent +                      (strata|link), family = beta_family(link = "logit"), data = rich)
# strata and elevation
mods_rich[[11]] <- glmmTMB(scaled_met ~ strata + elevation +                               (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[12]] <- glmmTMB(scaled_met ~ poly(strata, 2) + elevation +                      (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[13]] <- glmmTMB(scaled_met ~ poly(strata, 3) + elevation +                      (strata|link), family = beta_family(link = "logit"), data = rich)
# strata method
mods_rich[[14]] <- glmmTMB(scaled_met ~ strata + method +                                  (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[15]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method +                         (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[16]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method +                         (strata|link), family = beta_family(link = "logit"), data = rich)
# strata, elevation, and continent 
mods_rich[[17]] <- glmmTMB(scaled_met ~ strata + elevation + continent +                   (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[18]] <- glmmTMB(scaled_met ~ poly(strata, 2) + elevation + continent +          (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[19]] <- glmmTMB(scaled_met ~ poly(strata, 3) + elevation + continent +          (strata|link), family = beta_family(link = "logit"), data = rich)
# strata, method, and continent 
mods_rich[[20]] <- glmmTMB(scaled_met ~ strata + method + continent +                      (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[21]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method + continent +             (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[22]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method + continent +             (strata|link), family = beta_family(link = "logit"), data = rich)
# strata, method, and elevation 
mods_rich[[23]] <- glmmTMB(scaled_met ~ strata + method + continent + elevation +          (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[24]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method + continent + elevation + (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[25]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method + continent + elevation + (strata|link), family = beta_family(link = "logit"), data = rich)
# strata interactions with methods or continent or elevation 
mods_rich[[26]] <- glmmTMB(scaled_met ~ strata*method +                                    (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[27]] <- glmmTMB(scaled_met ~ strata*continent +                                 (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[28]] <- glmmTMB(scaled_met ~ strata*elevation +                                 (strata|link), family = beta_family(link = "logit"), data = rich)
# strata interactions with methods or continent or elevation plus additive relationships continent and elevation and methods 
mods_rich[[29]] <- glmmTMB(scaled_met ~ strata*method + continent +                        (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[30]] <- glmmTMB(scaled_met ~ strata*method + elevation +                        (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[31]] <- glmmTMB(scaled_met ~ strata*continent + method +                        (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[32]] <- glmmTMB(scaled_met ~ strata*continent + elevation +                     (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[33]] <- glmmTMB(scaled_met ~ strata*elevation + method +                        (strata|link), family = beta_family(link = "logit"), data = rich)
mods_rich[[34]] <- glmmTMB(scaled_met ~ strata*elevation + continent +                     (strata|link), family = beta_family(link = "logit"), data = rich)

mods_rich_bats_names <- list()
for(i in 1:length(mods_rich_bats)){
  mods_rich_bats_names[[i]] <- as.character(mods_rich_bats[[i]]$call$formula)
}

rich_bats_aictab <- aictab(cand.set = mods_rich_bats, modnames = unlist(mods_rich_bats_names)); rich_bats_aictab
```

## Creating AIC table
```{r Modeling species richness: creating AIC table}
rich_mod_names <- list()       # Extracting formulas from models 
for(i in 1:length(mods_rich)){
  rich_mod_names[[i]] <- as.character(mods_rich[[i]]$call$formula) # Using formulas to create model names
}

rich_modnames <- unlist(rich_mod_names) # Unpacking list of model formulas

rich_aictab <- aictab(cand.set = mods_rich, modnames = unlist(rich_mod_names)) # Setting formulas as model names

rich_aictab %>% 
  knitr::kable()

bbmle::AICtab(mods_rich, mnames = unlist(rich_mod_names), weights = T, logLik = T, k = T) 
```

## Model predictions
### Getting model esimates from top model using `sjPlot::get_model_data`
```{r Modeling species richness: esimates from top model}
top_rich_mod <- mods_rich[[as.numeric(str_extract(aictab(mods_rich)[1,1], "(\\d)+"))]] # Identifying top ranked model (automated)

model_estimates_rich <- sjPlot::get_model_data(top_rich_mod, type = "re", se = T, transform = NULL) # Extracting model estimates
```

### Getting model estimates from each richness model using `sjPlot::get_model_data`
```{r Modeling species richness: getting model averaged estimates}
# Creating matrices for model predictions; 4 matrices, each with 53 rows (for each study) and 34 cols (for each model)
## 4 matrices:
rich_length <- nrow(sjPlot::get_model_data(mods_rich[[1]], type = "re", se = T, transform = NULL))

rich_beta_intercept <- matrix(NA, nrow = rich_length/2, ncol = length(mods_rich))
### 2) Intercept uncertainty
rich_beta_intercept_se <- rich_beta_intercept
### 3) Slope
rich_beta_strata <- rich_beta_intercept
### 4) Slope uncertainty
rich_beta_strata_se <- rich_beta_intercept

## Extracting model estimates with `sjPlot::get_model_data`
for(i in 1:length(mods_rich)){
  ### 1) Intercept
  rich_beta_intercept[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[1:(rich_length/2),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 2) Intercept uncertainty
  rich_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[1:(rich_length/2),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
  ### 3) Slope
  rich_beta_strata[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[((rich_length/2)+1):(rich_length),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 4) Slope uncertainty
  rich_beta_strata_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[((rich_length/2)+1):(rich_length),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from `glmmTMB` class models using `AICcmodavg::modavgCustom`, a customized function for manual model averaging 
```{r Getting richness model estimates: model averaging model estimates}
# Initializing list for intercepts and slopes
rich_modavg_beta_intercept_list <- list() 
rich_modavg_beta_strata_list <- list() 

# Initializing data.frame for model averaged estimates of intercepts
rich_modavg_beta_intercept_matrix <- tibble(     
  Mod.avg.est = rep(NA, nrow(rich_beta_intercept)), # point estimates
  Uncond.SE = rep(NA, nrow(rich_beta_intercept)),   # unconditional uncertainty estimates
  Lower.CL = rep(NA, nrow(rich_beta_intercept)), # lower 95% confidence interval
  Upper.CL = rep(NA, nrow(rich_beta_intercept))) # upper95% confidence interval

# Initializing data.frame for model averaged estimates of slopes
rich_modavg_beta_strata_matrix <- rich_modavg_beta_intercept_matrix

# `AICcmodavg::modavgCustom` can only extract one point estimate for a number of models at a time, so we're looping over every term (across each model)
for(i in 1:nrow(rich_beta_intercept)){                                                     # this function takes the following data:
  rich_modavg_beta_intercept_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,  # log likelihood (LL)
                                                       K = rich_aictab$K, #                # number of terms in each model (K)
                                                       modnames = rich_modnames,           # model names (might be optional)
                                                       estimate = rich_beta_intercept[i,], # point estimate of each term 
                                                       se = rich_beta_intercept_se[i,],    # uncertainty for each term 
                                                       nobs = nrow(rich))                  # number of observations in each model (to compute degrees of freedom)
  # moving model estimates into the above data.frame
  rich_modavg_beta_intercept_matrix$Mod.avg.est[i] <- rich_modavg_beta_intercept_list[[i]]$Mod.avg.est 
  rich_modavg_beta_intercept_matrix$Uncond.SE[i] <- rich_modavg_beta_intercept_list[[i]]$Uncond.SE
  rich_modavg_beta_intercept_matrix$Lower.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Lower.CL
  rich_modavg_beta_intercept_matrix$Upper.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Upper.CL
  
  # repeat for slopes
  rich_modavg_beta_strata_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,
                                                    K = rich_aictab$K,
                                                    modnames = rich_modnames,
                                                    estimate = rich_beta_strata[i,],
                                                    se = rich_beta_strata_se[i,],
                                                    nobs = nrow(rich))
  rich_modavg_beta_strata_matrix$Mod.avg.est[i] <- rich_modavg_beta_strata_list[[i]]$Mod.avg.est
  rich_modavg_beta_strata_matrix$Uncond.SE [i] <- rich_modavg_beta_strata_list[[i]]$Uncond.SE
  rich_modavg_beta_strata_matrix$Lower.CL[i] <- rich_modavg_beta_strata_list[[i]]$Lower.CL
  rich_modavg_beta_strata_matrix$Upper.CL[i] <- rich_modavg_beta_strata_list[[i]]$Upper.CL
}

# Combining intercept and slope estimates into single data.frame
modavg_estimates_rich <- bind_rows(rich_modavg_beta_intercept_matrix,rich_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

# Linking movel term names and facet (a factor for the term type, intercept or slope)
modavg_estimates_rich$link <- model_estimates_rich$term
modavg_estimates_rich$facet <- model_estimates_rich$facet
```


### Model averaged predictions of expected values
#### From Marc Mazerolle: 
##### To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

### Doing what Marc said above to obtain model averaged predictions using `stats::predict`, a customized function for manual model averaging 
```{r Model averaging richness model estimates: model averaged predictions}
# Initializing matrices for model averaged predictions 
rich_pred_fit <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))
rich_pred_se <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))

# Obtaining predictions from each model
for(i in 1:length(mods_rich)){
  rich_pred_fit[,i] <- predict(mods_rich[[i]], se.fit = T, type = "response")$fit
  rich_pred_se[,i] <- predict(mods_rich[[i]], se.fit = T, type = "response")$se.fit
}

# Initializing a list for predictions from each model
rich_modavg_preds_list <- list()

# Initializing a data.frame to load model averaged estimates 
rich_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(rich)),
  Uncond.SE = rep(NA, nrow(rich)),
  Lower.CL = rep(NA, nrow(rich)),
  Upper.CL = rep(NA, nrow(rich)))

# The customized model averaging function also has to work one point prediction at a time, so here we loop over each point estimate across all models 
for(i in 1:nrow(rich_pred_fit)){
  rich_modavg_preds_list[[i]] <- modavgCustom(logL = rich_aictab$LL, 
                                  K = rich_aictab$K, 
                                  modnames = rich_modnames, 
                                  estimate = rich_pred_fit[i,], 
                                  se = rich_pred_se[i,],
                                  nobs = nrow(rich_pred_fit))
  rich_modavg_preds_matrix$Mod.avg.est[i] <- rich_modavg_preds_list[[i]]$Mod.avg.est
  rich_modavg_preds_matrix$Uncond.SE [i] <- rich_modavg_preds_list[[i]]$Uncond.SE
  rich_modavg_preds_matrix$Lower.CL[i] <- rich_modavg_preds_list[[i]]$Lower.CL
  rich_modavg_preds_matrix$Upper.CL[i] <- rich_modavg_preds_list[[i]]$Upper.CL
}
```

### Putting model estimates and predictions into something useful for plotting
```{r Model averaged richness predictions: shaping estimates and predictions}
rich$predictions_fit <- rich_modavg_preds_matrix$Mod.avg.est
rich$predictions_se.fit <- rich_modavg_preds_matrix$Uncond.SE
rich$predictions_95CI_lower <- rich_modavg_preds_matrix$Lower.CL
rich$predictions_95CI_upper <- rich_modavg_preds_matrix$Upper.CL
rich$predictions_95CI_lower[rich$predictions_95CI_lower < 0] <- 0
rich$predictions_95CI_upper[rich$predictions_95CI_upper > 1] <- 1

taxa_link_rich <- rich %>% 
  dplyr::group_by(taxa_order, link, continent, method) %>%
  dplyr::summarise(mean_elevation = mean(elevation)) %>%
  dplyr::full_join(modavg_estimates_rich, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58)

richness_intercept <- "Richness at lowest strata"
richness_slope <- "Change in richness with increasing strata"
taxa_link_rich$facet[taxa_link_rich$facet == "link (Intercept)"] <- richness_intercept
taxa_link_rich$facet[taxa_link_rich$facet == "strata"] <- richness_slope

taxa_link_rich_order <- taxa_link_rich %>%
  group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  arrange(estimate, .by_group = T)

taxa_link_rich_order$order <- rep(NA, nrow(taxa_link_rich))
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept])
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope])

taxa_link_rich_avg <- taxa_link_rich_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_rich_avg$order <- rep(NA, nrow(taxa_link_rich_avg))
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept])
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope])

(taxa_link_rich_order_slope <- taxa_link_rich_order %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_rich_avg_slope <- taxa_link_rich_avg %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plottingrichness predictions}
ggplot(rich, aes(y = predictions_fit, x = strata,
                  ymin = predictions_95CI_lower, 
                  ymax = predictions_95CI_upper,
                  fill = taxa_order, group = link)) + 
    ylab("Predicted species richness") + xlab("Mean strata height measure") +
    ggtitle("                                                               Richness") +
    geom_line(size = 1, alpha = 0.3) +
    geom_ribbon(color = NA, alpha = 0.2) +
    scale_fill_viridis_d("Taxa") +
    facet_grid(rows = vars(taxa), cols = vars(continent)) +
    theme_bw() + theme(legend.position = "bottom")
ggsave("analysis/figures/richness_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)
```

```{r Model averaged richness predictions: two panel plotting}
## Two panel figure
col_2_rich_est <- ggplot(taxa_link_rich_order, aes(x = rev(order), y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + coord_flip() + ylim(-7.5,7.5) +
  geom_hline(yintercept = 0, col = "grey80", size = 1, linetype = 1) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper, 
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = rev(taxa_link_rich_order$order[1:50]), labels = taxa_link_rich_order$link[1:50]) +
  facet_grid(cols = vars(factor(facet, levels = c(richness_intercept, richness_slope)))) + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none"); col_2_rich_est

col_2_rich_est_avg <- ggplot(taxa_link_rich_avg, aes(x = rev(taxa_order), y = estimate, col = taxa_order)) + 
  ylab("Slope estimate") + xlab(" ") + coord_flip() + ylim(-7.5,7.5) +
  geom_hline(yintercept = 0, col = "grey80", size = 1, linetype = 1) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper, 
                     ymin = CI_95_lower)) +
  scale_x_discrete(labels = rev(c("Birds","Bats","             Small mammals","Amphibians"))) +
  facet_grid(cols = vars(factor(facet, levels = c(richness_intercept, richness_slope)))) + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "bottom"); col_2_rich_est_avg

ggarrange(col_2_rich_est, col_2_rich_est_avg, ncol = 1, nrow = 2, heights = c(4,1), widths = c(4,1))
```

## Plot study coef with elevation
```{r}
taxa_link_rich_slope <- taxa_link_rich_order %>%
  filter(facet == "Change in richness with increasing strata")

ggplot(taxa_link_rich_slope, aes(x = mean_elevation, y = estimate, col = taxa_order)) + 
  ylab("Coef (Richness ~ Height") + xlab("Elevation") + geom_point(size = 1.5) + 
  geom_smooth(method = "glm") +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_richness_height.jpeg")

ggplot(taxa_link_rich_slope, aes(x = method, y = estimate, fill = taxa_order)) + 
  ylab("Coef (Richness ~ Height") + xlab("Method") + 
  geom_boxplot() + geom_jitter() +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_richness_height_method.jpeg")
```


# Modeling abundance
## Abundance GLMs
```{r Modeling abundance: GLMs, message=FALSE, warning=FALSE}
mods_abund <- list()
# strata only models 
mods_abund[[1]]  <- glmmTMB(scaled_met ~ 1 +                                                (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[2]]  <- glmmTMB(scaled_met ~ strata +                                           (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[3]]  <- glmmTMB(scaled_met ~ poly(strata, 2) +                                  (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[4]]  <- glmmTMB(scaled_met ~ poly(strata, 3) +                                  (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
# strata and taxa
mods_abund[[5]]  <- glmmTMB(scaled_met ~ strata + taxa +                                    (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[6]]  <- glmmTMB(scaled_met ~ poly(strata, 2) + taxa +                           (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[7]]  <- glmmTMB(scaled_met ~ poly(strata, 3) + taxa +                           (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
# strata and continent 
mods_abund[[8]]  <- glmmTMB(scaled_met ~ strata + continent +                               (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[9]]  <- glmmTMB(scaled_met ~ poly(strata, 2) + continent +                      (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[10]] <- glmmTMB(scaled_met ~ poly(strata, 3) + continent +                      (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
# strata and elevation
mods_abund[[11]] <- glmmTMB(scaled_met ~ strata + elevation +                               (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[12]] <- glmmTMB(scaled_met ~ poly(strata, 2) + elevation +                      (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[13]] <- glmmTMB(scaled_met ~ poly(strata, 3) + elevation +                      (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
# strata method
mods_abund[[14]] <- glmmTMB(scaled_met ~ strata + method +                                  (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[15]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method +                         (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[16]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method +                         (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
# strata, elevation, and continent 
mods_abund[[17]] <- glmmTMB(scaled_met ~ strata + elevation + continent +                   (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[18]] <- glmmTMB(scaled_met ~ poly(strata, 2) + elevation + continent +          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[19]] <- glmmTMB(scaled_met ~ poly(strata, 3) + elevation + continent +          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[20]] <- glmmTMB(scaled_met ~ poly(strata, 3) + elevation + continent + taxa +   (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
# strata, method, and continent 
mods_abund[[21]] <- glmmTMB(scaled_met ~ strata + method + continent +                      (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[22]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method + continent +             (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[23]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method + continent +             (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
# strata, method, and elevation 
mods_abund[[24]] <- glmmTMB(scaled_met ~ strata + method + continent + elevation +          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[25]] <- glmmTMB(scaled_met ~ poly(strata, 2) + method + continent + elevation + (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[26]] <- glmmTMB(scaled_met ~ poly(strata, 3) + method + continent + elevation + (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
# strata interactions with methods or continent or elevation 
mods_abund[[27]] <- glmmTMB(scaled_met ~ strata*method +                                    (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[28]] <- glmmTMB(scaled_met ~ strata*continent +                                 (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[29]] <- glmmTMB(scaled_met ~ strata*elevation +                                 (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
#
mods_abund[[30]] <- glmmTMB(scaled_met ~ strata*continent + taxa +                          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[31]] <- glmmTMB(scaled_met ~ strata*elevation + taxa +                          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
# strata interactions with methods or continent or elevation plus additive relationships continent and elevation and methods 
mods_abund[[32]] <- glmmTMB(scaled_met ~ strata*method + continent +                        (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[33]] <- glmmTMB(scaled_met ~ strata*method + elevation +                        (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[34]] <- glmmTMB(scaled_met ~ strata*continent + method +                        (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
#
mods_abund[[35]] <- glmmTMB(scaled_met ~ strata*taxa + continent +                          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
mods_abund[[36]] <- glmmTMB(scaled_met ~ strata*taxa + elevation +                          (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
#
mods_abund[[37]] <- glmmTMB(scaled_met ~ strata*continent + elevation +                     (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[38]] <- glmmTMB(scaled_met ~ strata*elevation + method +                        (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund) 
mods_abund[[39]] <- glmmTMB(scaled_met ~ strata*elevation + continent +                     (strata|link), weights = bin_weight, family = beta_family(link = "logit"), data = abund)
```

### Extracting model formulas to label aic table 
```{r}
abund_mod_names <- list()
for(i in 1:length(mods_abund)){
  abund_mod_names[[i]] <- as.character(mods_abund[[i]]$call$formula)
}

abund_modnames <- unlist(abund_mod_names)

abund_aictab <- aictab(cand.set = mods_abund, modnames = unlist(abund_mod_names))
abund_aictab
```

### Getting model esimates from top abundance model 
```{r Getting abundance model esimates from top model}
top_abund_mod <- mods_abund[[as.numeric(str_extract(aictab(mods_abund)[1,1], "(\\d)+"))]]

model_estimates_abund <- sjPlot::get_model_data(top_abund_mod, type = "re", se = T, transform = NULL)

length_abund <- nrow(model_estimates_abund[model_estimates_abund$facet == "link (Intercept)",])
```

### Getting model estimates from all models 
```{r Getting abundance model esimates from all models}
abund_term_length <- nrow(sjPlot::get_model_data(mods_abund[[1]], type = "re", se = T, transform = NULL))

abund_beta_intercept <- matrix(NA, nrow = abund_term_length/2, ncol = length(mods_abund))
abund_beta_intercept_se <- abund_beta_intercept
abund_beta_strata <- abund_beta_intercept
abund_beta_strata_se <- abund_beta_intercept

for(i in 1:length(mods_abund)){
  abund_beta_intercept[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[1:(abund_term_length/2),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  
  abund_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[1:(abund_term_length/2),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()

  abund_beta_strata[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[((abund_term_length/2) + 1):abund_term_length,] %>%
    dplyr::select(estimate) %>%
    as.matrix()

  abund_beta_strata_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[((abund_term_length/2) + 1):abund_term_length,] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from all models 
```{r Model averaging abundance models: term estimates}
abund_modavg_beta_intercept_list <- list()
abund_modavg_beta_strata_list <- list()

abund_modavg_beta_intercept_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund_beta_intercept)),
  Uncond.SE = rep(NA, nrow(abund_beta_intercept)),
  Lower.CL = rep(NA, nrow(abund_beta_intercept)),
  Upper.CL = rep(NA, nrow(abund_beta_intercept)))

abund_modavg_beta_strata_matrix <- abund_modavg_beta_intercept_matrix

for(i in 1:nrow(abund_beta_intercept)){
  abund_modavg_beta_intercept_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                                       K = abund_aictab$K, 
                                                       modnames = abund_modnames, 
                                                       estimate = abund_beta_intercept[i,],
                                                       se = abund_beta_intercept_se[i,],
                                                       nobs = nrow(abund))
  abund_modavg_beta_intercept_matrix$Mod.avg.est[i] <- abund_modavg_beta_intercept_list[[i]]$Mod.avg.est
  abund_modavg_beta_intercept_matrix$Uncond.SE [i] <- abund_modavg_beta_intercept_list[[i]]$Uncond.SE
  abund_modavg_beta_intercept_matrix$Lower.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Lower.CL
  abund_modavg_beta_intercept_matrix$Upper.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Upper.CL
  
  abund_modavg_beta_strata_list[[i]] <- modavgCustom(logL = abund_aictab$LL,
                                                    K = abund_aictab$K,
                                                    modnames = abund_modnames,
                                                    estimate = abund_beta_strata[i,],
                                                    se = abund_beta_strata_se[i,],
                                                    nobs = nrow(abund))
  abund_modavg_beta_strata_matrix$Mod.avg.est[i] <- abund_modavg_beta_strata_list[[i]]$Mod.avg.est
  abund_modavg_beta_strata_matrix$Uncond.SE [i] <- abund_modavg_beta_strata_list[[i]]$Uncond.SE
  abund_modavg_beta_strata_matrix$Lower.CL[i] <- abund_modavg_beta_strata_list[[i]]$Lower.CL
  abund_modavg_beta_strata_matrix$Upper.CL[i] <- abund_modavg_beta_strata_list[[i]]$Upper.CL
}

modavg_estimates_abund <- bind_rows(abund_modavg_beta_intercept_matrix,abund_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

modavg_estimates_abund$link <- model_estimates_abund$term
modavg_estimates_abund$facet <- model_estimates_abund$facet
```


### Model averaged predictions of expected values
## From Marc Mazerolle: 
## To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

#### Doing what Marc said ^
```{r Model averaging abundance models: predictions}
abund_pred_fit <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))
abund_pred_se <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))

for(i in 1:length(mods_abund)){
  abund_pred_fit[,i] <- predict(mods_abund[[i]], se.fit = T, type = "response")$fit
  abund_pred_se[,i] <- predict(mods_abund[[i]], se.fit = T, type = "response")$se.fit
}

abund_modavg_preds_list <- list()

abund_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund)),
  Uncond.SE = rep(NA, nrow(abund)),
  Lower.CL = rep(NA, nrow(abund)),
  Upper.CL = rep(NA, nrow(abund)))

for(i in 1:nrow(abund_pred_fit)){
  abund_modavg_preds_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                               K = abund_aictab$K, 
                                               modnames = abund_modnames, 
                                               estimate = abund_pred_fit[i,], 
                                               se = abund_pred_se[i,],
                                               nobs = nrow(abund_pred_fit))
  abund_modavg_preds_matrix$Mod.avg.est[i] <- abund_modavg_preds_list[[i]]$Mod.avg.est
  abund_modavg_preds_matrix$Uncond.SE[i] <- abund_modavg_preds_list[[i]]$Uncond.SE
  abund_modavg_preds_matrix$Lower.CL[i] <- abund_modavg_preds_list[[i]]$Lower.CL
  abund_modavg_preds_matrix$Upper.CL[i] <- abund_modavg_preds_list[[i]]$Upper.CL
}
```

### Getting data ready for plotting
```{r Model averaging abundance models: preparing data for plotting}
abund$predictions_fit <- abund_modavg_preds_matrix$Mod.avg.est
abund$predictions_se.fit <- abund_modavg_preds_matrix$Uncond.SE
abund$predictions_95CI_lower <- abund_modavg_preds_matrix$Lower.CL
abund$predictions_95CI_upper <- abund_modavg_preds_matrix$Upper.CL
abund$predictions_95CI_lower[abund$predictions_95CI_lower < 0] <- 0
abund$predictions_95CI_upper[abund$predictions_95CI_upper > 1] <- 1

(taxa_link_abund <- abund %>% 
  dplyr::group_by(taxa_order,link,continent,method) %>%
  dplyr::summarise(mean_elevation = mean(elevation)) %>%
  dplyr::full_join(modavg_estimates_abund, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58))

abundance_intercept <- "Abundance at lowest strata"
abundance_slope <- "Change in abundance with increasing strata"
taxa_link_abund$facet[taxa_link_abund$facet == "link (Intercept)"] <- abundance_intercept
taxa_link_abund$facet[taxa_link_abund$facet == "strata"] <- abundance_slope

taxa_link_abund_order <- taxa_link_abund %>%
  dplyr::group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T)

taxa_link_abund_order$order <- rep(NA, nrow(taxa_link_abund))
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept])
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope])

taxa_link_abund_avg <- taxa_link_abund_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_abund_avg$order <- rep(NA, nrow(taxa_link_abund_avg))
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept])
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope])

(taxa_link_abund_order_slope <- taxa_link_abund_order %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_abund_avg_slope <- taxa_link_abund_avg %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plotting abundance data}
ggplot(abund, aes(y = predictions_fit, x = strata,
                 ymin = predictions_95CI_lower, 
                 ymax = predictions_95CI_upper,
                 fill = taxa_order, group = link)) + 
  ylab("Predicted species abundance") + xlab("Mean strata height measure") +
  ggtitle("                                                            Abundance") +
  geom_line(size = 1, alpha = 0.3) +
  geom_ribbon(color = NA, alpha = 0.2) +
  scale_fill_viridis_d("Taxa") +
  facet_grid(rows = vars(taxa), cols = vars(continent)) + theme_bw() + 
  theme(legend.position = "bottom");
ggsave("analysis/figures/abundance_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)
```
### Plotting abundance: Two panel figure
```{r Plotting abundance: Two panel figure}
## Two panel figure
col_2_abund_est <- ggplot(taxa_link_abund_order, aes(x = rev(order), y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, col = "grey80", size = 1, linetype = 1) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = rev(taxa_link_abund_order$order[1:length_abund]), labels = taxa_link_abund_order$link[1:length_abund]) +
  facet_grid(cols = vars(factor(facet, levels = c(abundance_intercept, abundance_slope)))) + 
  scale_color_viridis_d("Taxa") + theme_bw() + theme(legend.position = "none"); col_2_abund_est

col_2_abund_est_avg <- ggplot(taxa_link_abund_avg, aes(x = rev(taxa_order), y = estimate, col = taxa_order)) + 
  ylab("Slope estimate") + xlab(" ") + coord_flip() + ylim(-10,10) +
  geom_hline(yintercept = 0, col = "grey80", size = 1, linetype = 1) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_discrete(labels = rev(c("Birds","Bats","             Small mammals","Amphibians"))) +
  facet_grid(cols = vars(factor(facet, levels = c(abundance_intercept, abundance_slope)))) + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "bottom"); col_2_abund_est_avg

ggarrange(col_2_abund_est, col_2_abund_est_avg, ncol = 1, nrow = 2, heights = c(4,1), widths = c(4,1))
```

## Plot study coef with elevation
```{r}
taxa_link_abund_slope <- taxa_link_abund_order %>%
  filter(facet == "Change in abundance with increasing strata")

ggplot(taxa_link_abund_slope, aes(x = mean_elevation, y = estimate, col = taxa_order)) + 
  ylab("Coef (Abund ~ Height)") + xlab("Elevation") + geom_point() +
  geom_smooth(method = "glm") +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_abund_height.jpeg")

ggplot(taxa_link_abund_slope, aes(x = method, y = estimate, fill = taxa_order)) + 
  ylab("Coef (Abundance ~ Height)") + xlab("Method") + 
  geom_boxplot() + geom_jitter() +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_abund_height_method.jpeg")
```

## Plotting slopes of abundance and richness
```{r Plotting slopes of abundance and richness}
taxa_link_slope <- bind_rows(
  tibble::tibble(taxa_link_abund_order_slope, metric = "abundance"), 
  tibble::tibble(taxa_link_rich_order_slope, metric = "richness")) %>%
  dplyr::select(!c(facet, `factor(...)`, continent, order)) %>%
  dplyr::group_by(taxa_order = factor(taxa_order, levels = c("Bats","Birds","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T) 

taxa_link_slope_rich <- taxa_link_slope %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich$order <- rev(taxa_link_slope_rich$order)
taxa_link_slope_abund <- taxa_link_slope %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund$order <- rev(taxa_link_slope_abund$order)

# Averaging estimates to the taxa level
(taxa_link_slope_avg <- taxa_link_slope %>%
    dplyr::select(taxa_order, estimate, se, CI_95_lower, CI_95_upper, CI_99_lower, CI_99_upper, CI_80_lower, CI_80_upper, sig, metric) %>%
    dplyr::group_by(metric, taxa_order) %>%
    dplyr::summarise(estimate = mean(estimate),
              CI_95_upper = mean(CI_95_upper),
              CI_95_lower = mean(CI_95_lower),
              CI_80_upper = mean(CI_80_upper),
              CI_80_lower = mean(CI_80_lower),
              CI_99_upper = mean(CI_99_upper),
              CI_99_lower = mean(CI_99_lower)) %>%
    dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
    dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
    dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
    dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                                if_else(sig_95 == "*", "**", 
                                        if_else(sig_80 == "*", "*", "")))))

taxa_link_slope_rich_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich_avg$order <- rev(taxa_link_slope_rich_avg$order)

taxa_link_slope_abund_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund_avg$order <- rev(taxa_link_slope_abund_avg$order)

# reformatting the links to look more like citations
taxa_link_slope_rich_plot <- taxa_link_slope_rich %>% 
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))
taxa_link_slope_abund_plot <- taxa_link_slope_abund %>%
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))

```

### Creating slope estimate figures for both richness and abundance
```{r Creating slope estimate figures for both richness and abundance}
col_2_slope_rich_est_cont <- ggplot(taxa_link_slope_rich, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                   Species Richness") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_rich_plot$order, 
                     labels = taxa_link_slope_rich_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-8.5, 8.5), breaks = seq(-8, 8, by = 2), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-4.2,0,4.2), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  annotate("text", x = seq(56, 54), y = rep(4.5,3), 
           label = c("  * = 80% CI excludes 0"," ** = 95% CI excludes 0","*** = 99% CI excludes 0"), size = 3) +
  scale_color_viridis_d("Taxa") + theme_classic() +
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"), 
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,0,0,0), "lines")); col_2_slope_rich_est_cont

col_2_slope_abund_est_cont <- ggplot(taxa_link_slope_abund, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                        Abundance") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_abund_plot$order, 
                     labels = taxa_link_slope_abund_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-12,12), breaks = seq(-12, 12, by = 4), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-6,0,6), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,1,0,0), "lines")); col_2_slope_abund_est_cont

col_2_slope_est_cont <- ggarrange(col_2_slope_rich_est_cont, col_2_slope_abund_est_cont); col_2_slope_est_cont

col_2_slope_rich_avg_cont <- ggplot(taxa_link_slope_rich_avg, 
                               aes(x = factor(taxa_order, levels = c(
                                "Small mammals", "Amphibians", "Birds", "Bats"
                               )), y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats","Birds","Amphibians", "      Small Mammals"))) +
  scale_y_continuous(limits = c(-8.5,8.5), breaks = seq(-8, 8, by = 2), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-4.2,0,4.2), labels = c("Decreasing"," ","Increasing"))) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = c(.5,-0.1), legend.direction = "horizontal", panel.border = element_rect(colour = "black", fill=NA, size=1), 
        axis.text.x.top = element_text(size = 8), legend.title.align = 0.5,
        axis.ticks.length.x.top = unit(0, "cm"),
        axis.line = element_blank(), plot.margin = unit(c(0,0,0,0), "lines")) + 
  guides(colour = guide_legend(title.position = "top")); col_2_slope_rich_avg_cont

col_2_slope_abund_avg_cont <- ggplot(taxa_link_slope_abund_avg, 
                                aes(x = factor(taxa_order, levels = c(
                                "Small mammals", "Amphibians", "Birds", "Bats"
                               )), y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats", "Birds", "Amphibians", "      Small Mammals"))) +
  scale_y_continuous(limits = c(-12,12), breaks = seq(-12, 12, by = 4), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-6,0,6), labels = c("Decreasing"," ","Increasing"))) +  scale_color_viridis_d(" ") + theme_classic() + 
  theme(legend.position = "none", panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        legend.text=element_text(color="white"),
        axis.line = element_blank(), plot.margin = unit(c(0,1,0,0), "lines")) + 
  guides(color=guide_legend(override.aes=list(fill="white", col = "white"))); col_2_slope_abund_avg_cont

col_2_slope_avg_cont <- ggarrange(col_2_slope_rich_avg_cont, col_2_slope_abund_avg_cont, common.legend = T, legend = "bottom"); col_2_slope_avg_cont
ggarrange(col_2_slope_est_cont, col_2_slope_avg_cont, nrow = 2, heights = c(6,1.5))
ggsave("analysis/figures/parm_taxa_4_panel.jpeg", width = 10, height = 10, units = "in", dpi = 300)
```