---
title: "Modeling biodiversity metrics"
author: "Alex Baecher & Ed Basham"
date: "12/18/2020"
output:
  pdf_document: default
---

# Preparing workspace
## Calling libraries

```{r load packages, message=TRUE, warning=TRUE}
library(lme4)
library(AICcmodavg)
library(glmmTMB)
library(TMB)
library(tidyverse)
library(readr)
library(scales)
library(formula.tools)
library(sjPlot)
library(ggpubr)
library(Hmisc)
library(visreg)
library(bbmle)
```

## Loading data
```{r loading data}
dat <- read_csv("data/stripped_data/final/data_joined.csv") %>%
  dplyr::filter(taxa != "All mammals") %>%
  dplyr::filter(taxa != "Primates") %>%
  dplyr::mutate(weight = spatial_rank + temporal_bredth_rank + temporal_resolution_rank,
                taxa = as.factor(taxa),
                taxa_order = factor(taxa, levels = c("Birds","Bats","Small mammals","Amphibians")),
                elevation = as.numeric(scale(elevation)),
                scaled_met = as.numeric(rescale(corrected_biodiversity_metric_value, to = c(1e-05, 0.99999))),
                link = as.factor(link), 
                method = as.factor(method), 
                treatment = as.factor(treatment),
                continent = as.factor(continent),
                biodiversity_metric = as.factor(biodiversity_metric), 
                season = as.factor(season), 
                forest_type = as.factor(forest_type),  
                mean_strata_height_p = as.numeric(scale(mean_strata_height_p)),
                canopy_height = as.numeric(scale(canopy_height)),
                latitude = as.numeric(scale(latitude)),
                longitude = as.numeric(scale(longitude)),
                strata = as.numeric(scale(mean_strata_height_p))) %>%
  dplyr::select(link, study_id.x, method, taxa, bin_weight, weight, indepedence_weight, 
                continent, biodiversity_metric, taxa_order, treatment, season, forest_type, 
                elevation, canopy_height, latitude, longitude, scaled_met, strata) %>%
  dplyr::mutate(weight = as.numeric(scale(weight)*indepedence_weight))

glimpse(dat)

abund <- dat %>%
  dplyr::filter(biodiversity_metric == "abundance")

rich <- dat %>% 
  dplyr::filter(biodiversity_metric == "richness")
```

# Modeling species richness
## Richness GLMs
```{r Creating model formulas, message=FALSE, warning=FALSE}
model_formulas_ch <- list("scaled_met ~ 1 + weight + (strata | link)",
                          "scaled_met ~ strata + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + weight + (strata | link)",

                          "scaled_met ~ strata + taxa + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + taxa + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + taxa + weight + (strata | link)",

                          "scaled_met ~ strata + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + continent + weight + (strata | link)",

                          "scaled_met ~ strata +          elevation + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + elevation + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + elevation + weight + (strata | link)",

                          "scaled_met ~ strata +          longitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + longitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + longitude + weight + (strata | link)",

                          "scaled_met ~ strata +          canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + canopy_height + weight + (strata | link)",

                          "scaled_met ~ strata +          latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + latitude + weight + (strata | link)",

                          "scaled_met ~ strata +          method + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + method + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + method + weight + (strata | link)",

                          "scaled_met ~ strata +          elevation + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + elevation + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + elevation + continent + weight + (strata | link)",

                          "scaled_met ~ strata +          elevation + latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + elevation + latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + elevation + latitude + weight + (strata | link)",

                          "scaled_met ~ strata +          elevation + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + elevation + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + elevation + canopy_height + weight + (strata | link)",

                          "scaled_met ~ strata +          latitude + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + latitude + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + latitude + canopy_height + weight + (strata | link)",

                          "scaled_met ~ strata +          method + latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + method + latitude + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + method + latitude + weight + (strata | link)",

                          "scaled_met ~ strata +          method + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + method + canopy_height + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + method + canopy_height + weight + (strata | link)",

                          "scaled_met ~ strata +          method + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) + method + continent + weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) + method + continent + weight + (strata | link)",

                          "scaled_met ~ strata +          method + continent + elevation + weight + (strata | link)",
                          "scaled_met ~ strata +          method + canopy_height + elevation + weight + (strata | link)",
                          
                          "scaled_met ~ poly(strata, 3) + method + continent + elevation + weight + (strata | link)",

                          "scaled_met ~ strata * method + weight + (strata | link)",
                          "scaled_met ~ strata * continent + weight + (strata | link)",
                          "scaled_met ~ strata * elevation + weight + (strata | link)",

                          "scaled_met ~ strata * method + continent + weight + (strata | link)",
                          "scaled_met ~ strata * continent + method + weight + (strata | link)",
                          "scaled_met ~ strata * continent + elevation + weight + (strata | link)",
                          "scaled_met ~ strata * elevation + method + weight + (strata | link)",
                          "scaled_met ~ strata * elevation + continent + weight + (strata | link)")

```

## Running models 
```{r Creating models}
model_formulas <- lapply(paste(model_formulas_ch), as.formula)

mods_rich <- lapply(model_formulas, function(x){      # using lappy, instead of for loops 
  glmmTMB(x, family = beta_family(link = "logit"), 
          weights = bin_weight, 
          data = rich)
  })

rich_aictab <- aictab(cand.set = mods_rich, modnames = unlist(model_formulas_ch)); rich_aictab
```

## Model predictions
### Getting model esimates from top model using `sjPlot::get_model_data`
```{r Modeling species richness: esimates from top model}
top_rich_mod <- mods_rich[[as.numeric(str_extract(aictab(mods_rich)[1,1], "(\\d)+"))]] # Identifying top ranked model (automated)

model_estimates_rich <- sjPlot::get_model_data(top_rich_mod, type = "re", se = T, transform = NULL) # Extracting model estimates
```

### Getting model estimates from each richness model using `sjPlot::get_model_data`
```{r Modeling species richness: getting model averaged estimates}
# Creating matrices for model predictions; 4 matrices, each with 53 rows (for each study) and 34 cols (for each model)
## 4 matrices:
rich_length_total <- nrow(sjPlot::get_model_data(top_rich_mod, type = "re", se = T, transform = NULL))
rich_length <- rich_length_total/2

rich_beta_intercept <- matrix(NA, nrow = rich_length, ncol = length(mods_rich))
### 2) Intercept uncertainty
rich_beta_intercept_se <- rich_beta_intercept
### 3) Slope
rich_beta_strata <- rich_beta_intercept
### 4) Slope uncertainty
rich_beta_strata_se <- rich_beta_intercept

## Extracting model estimates with `sjPlot::get_model_data`
for(i in 1:length(mods_rich)){
  ### 1) Intercept
  rich_beta_intercept[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[1:(rich_length),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 2) Intercept uncertainty
  rich_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[1:(rich_length),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
  ### 3) Slope
  rich_beta_strata[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[((rich_length)+1):(rich_length_total),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 4) Slope uncertainty
  rich_beta_strata_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", se = T, transform = NULL)[((rich_length)+1):(rich_length_total),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from `glmmTMB` class models using `AICcmodavg::modavgCustom`, a customized function for manual model averaging 
```{r Getting richness model estimates: model averaging model estimates, message=FALSE, warning=FALSE}
# Initializing list for intercepts and slopes
rich_modavg_beta_intercept_list <- list() 
rich_modavg_beta_strata_list <- list() 

# Initializing data.frame for model averaged estimates of intercepts
rich_modavg_beta_intercept_matrix <- tibble(     
  Mod.avg.est = rep(NA, nrow(rich_beta_intercept)), # point estimates
  Uncond.SE = rep(NA, nrow(rich_beta_intercept)),   # unconditional uncertainty estimates
  Lower.CL = rep(NA, nrow(rich_beta_intercept)), # lower 95% confidence interval
  Upper.CL = rep(NA, nrow(rich_beta_intercept))) # upper95% confidence interval

# Initializing data.frame for model averaged estimates of slopes
rich_modavg_beta_strata_matrix <- rich_modavg_beta_intercept_matrix

# `AICcmodavg::modavgCustom` can only extract one point estimate for a number of models at a time, so we're looping over every term (across each model)
for(i in 1:nrow(rich_beta_intercept)){                                                     # this function takes the following data:
  rich_modavg_beta_intercept_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,  # log likelihood (LL)
                                                       K = rich_aictab$K, #                # number of terms in each model (K)
                                                       estimate = rich_beta_intercept[i,], # point estimate of each term 
                                                       se = rich_beta_intercept_se[i,],    # uncertainty for each term 
                                                       nobs = nrow(rich))                  # number of observations in each model (to compute degrees of freedom)
  # moving model estimates into the above data.frame
  rich_modavg_beta_intercept_matrix$Mod.avg.est[i] <- rich_modavg_beta_intercept_list[[i]]$Mod.avg.est 
  rich_modavg_beta_intercept_matrix$Uncond.SE[i] <- rich_modavg_beta_intercept_list[[i]]$Uncond.SE
  rich_modavg_beta_intercept_matrix$Lower.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Lower.CL
  rich_modavg_beta_intercept_matrix$Upper.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Upper.CL
  
  # repeat for slopes
  rich_modavg_beta_strata_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,
                                                    K = rich_aictab$K,
                                                    estimate = rich_beta_strata[i,],
                                                    se = rich_beta_strata_se[i,],
                                                    nobs = nrow(rich))
  rich_modavg_beta_strata_matrix$Mod.avg.est[i] <- rich_modavg_beta_strata_list[[i]]$Mod.avg.est
  rich_modavg_beta_strata_matrix$Uncond.SE [i] <- rich_modavg_beta_strata_list[[i]]$Uncond.SE
  rich_modavg_beta_strata_matrix$Lower.CL[i] <- rich_modavg_beta_strata_list[[i]]$Lower.CL
  rich_modavg_beta_strata_matrix$Upper.CL[i] <- rich_modavg_beta_strata_list[[i]]$Upper.CL
}

# Combining intercept and slope estimates into single data.frame
modavg_estimates_rich <- bind_rows(rich_modavg_beta_intercept_matrix,rich_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

# Linking movel term names and facet (a factor for the term type, intercept or slope)
modavg_estimates_rich$link <- model_estimates_rich$term
modavg_estimates_rich$facet <- model_estimates_rich$facet
```


### Model averaged predictions of expected values
#### From Marc Mazerolle: 
##### To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

### Doing what Marc said above to obtain model averaged predictions using `stats::predict`, a customized function for manual model averaging 
```{r Model averaging richness model estimates: model averaged predictions, message=FALSE, warning=FALSE}
# Initializing matrices for model averaged predictions 
rich_pred_fit <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))
rich_pred_se <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))

new_rich <- rich %>%
  mutate(weight = max(weight))

# Obtaining predictions from each model
for(i in 1:length(mods_rich)){
  rich_pred_fit[,i] <- predict(mods_rich[[i]], se.fit = T, newdata = new_rich, type = "response")$fit
  rich_pred_se[,i] <- predict(mods_rich[[i]], se.fit = T, newdata = new_rich, type = "response")$se.fit
}

# Initializing a list for predictions from each model
rich_modavg_preds_list <- list()

# Initializing a data.frame to load model averaged estimates 
rich_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(rich)),
  Uncond.SE = rep(NA, nrow(rich)),
  Lower.CL = rep(NA, nrow(rich)),
  Upper.CL = rep(NA, nrow(rich)))

# The customized model averaging function also has to work one point prediction at a time, so here we loop over each point estimate across all models 
for(i in 1:nrow(rich_pred_fit)){
  rich_modavg_preds_list[[i]] <- modavgCustom(logL = rich_aictab$LL, 
                                              K = rich_aictab$K, 
                                              estimate = rich_pred_fit[i,], 
                                              se = rich_pred_se[i,],
                                              nobs = nrow(rich_pred_fit))
  rich_modavg_preds_matrix$Mod.avg.est[i] <- rich_modavg_preds_list[[i]]$Mod.avg.est
  rich_modavg_preds_matrix$Uncond.SE [i] <- rich_modavg_preds_list[[i]]$Uncond.SE
  rich_modavg_preds_matrix$Lower.CL[i] <- rich_modavg_preds_list[[i]]$Lower.CL
  rich_modavg_preds_matrix$Upper.CL[i] <- rich_modavg_preds_list[[i]]$Upper.CL
}
```

### Putting model estimates and predictions into something useful for plotting
```{r Model averaged richness predictions: shaping estimates and predictions}
rich$predictions_fit <- rich_modavg_preds_matrix$Mod.avg.est
rich$predictions_se.fit <- rich_modavg_preds_matrix$Uncond.SE
rich$predictions_95CI_lower <- rich_modavg_preds_matrix$Lower.CL
rich$predictions_95CI_upper <- rich_modavg_preds_matrix$Upper.CL
rich$predictions_95CI_lower[rich$predictions_95CI_lower < 0] <- 0
rich$predictions_95CI_upper[rich$predictions_95CI_upper > 1] <- 1

taxa_link_rich <- rich %>% 
  dplyr::group_by(taxa_order, link, continent, method) %>%
  dplyr::summarise(mean_elevation = mean(elevation),
                   mean_latitude = mean(latitude),
                   canopy_height = mean(canopy_height)) %>%
  dplyr::full_join(modavg_estimates_rich, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58)

richness_intercept <- "Richness at lowest strata"
richness_slope <- "Change in richness with increasing strata"
taxa_link_rich$facet[taxa_link_rich$facet == "link (Intercept)"] <- richness_intercept
taxa_link_rich$facet[taxa_link_rich$facet == "strata"] <- richness_slope

taxa_link_rich_order <- taxa_link_rich %>%
  group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  arrange(estimate, .by_group = T)

taxa_link_rich_order$order <- rep(NA, nrow(taxa_link_rich))
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept])
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope])

taxa_link_rich_avg <- taxa_link_rich_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_rich_avg$order <- rep(NA, nrow(taxa_link_rich_avg))
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept])
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope])

(taxa_link_rich_order_slope <- taxa_link_rich_order %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_rich_avg_slope <- taxa_link_rich_avg %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plottingrichness predictions}
ggplot(rich, aes(y = predictions_fit, x = strata,
                  ymin = predictions_95CI_lower, 
                  ymax = predictions_95CI_upper,
                  fill = taxa_order, group = link)) + 
    ylab("Predicted species richness") + xlab("Mean strata height measure") +
    ggtitle("                                                               Richness") +
    geom_line(size = 1, alpha = 0.3) +
    geom_ribbon(color = NA, alpha = 0.2) +
    scale_fill_viridis_d("Taxa") +
    facet_wrap(~continent*taxa_order) +
    theme_bw() + theme(legend.position = "bottom")
ggsave("analysis/figures/richness_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)


ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = abs(mean_latitude), col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Absolute Latitude") +
  ggtitle("Species Richness") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_rich_height_lat.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = mean_elevation, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Elevation") +
  ggtitle("Species Richness") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_rich_height_elv.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = canopy_height, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Canopy Height") +
  ggtitle("Species Richness") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_rich_height_canopy.jpeg", width = 8, height = 6, units = "in", dpi = 300)

```

## Plot study coef with elevation
```{r}
taxa_link_rich_slope <- taxa_link_rich_order %>%
  filter(facet == "Change in richness with increasing strata")

ggplot(taxa_link_rich_slope, aes(x = mean_elevation, y = estimate, col = taxa_order)) + 
  ylab("Coef (Richness ~ Height)") + xlab("Elevation") + geom_point(size = 1.5) + 
  geom_smooth(method = "glm") +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_richness_height.jpeg")

ggplot(taxa_link_rich_slope, aes(x = method, y = estimate, fill = taxa_order)) + 
  ylab("Coef (Richness ~ Height)") + xlab("Method") + 
  geom_boxplot() + geom_jitter() +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_richness_height_method.jpeg")
```
# Modeling abundance
## Abundance GLMs
```{r Modeling abundance: GLMs, message=FALSE, warning=FALSE}
mods_abund <- lapply(model_formulas, function(x){
  glmmTMB(x, family = beta_family(link = "logit"), 
          weights = bin_weight, 
          data = abund)
  })

abund_aictab <- aictab(cand.set = mods_abund, modnames = unlist(model_formulas_ch)); abund_aictab
```

### Getting model esimates from top abundance model 
```{r Getting abundance model esimates from top model}
top_abund_mod <- mods_abund[[as.numeric(str_extract(aictab(mods_abund)[1,1], "(\\d)+"))]]

model_estimates_abund <- sjPlot::get_model_data(top_abund_mod, type = "re", se = T, transform = NULL)
```

### Getting model estimates from all models 
```{r Getting abundance model esimates from all models}
abund_length_total <- nrow(model_estimates_abund)
abund_length <- abund_length_total/2

abund_beta_intercept <- matrix(NA, nrow = abund_length, ncol = length(mods_abund))
abund_beta_intercept_se <- abund_beta_intercept
abund_beta_strata <- abund_beta_intercept
abund_beta_strata_se <- abund_beta_intercept

for(i in 1:length(mods_abund)){
  abund_beta_intercept[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[1:(abund_length),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  
  abund_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[1:(abund_length),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()

  abund_beta_strata[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[((abund_length) + 1):abund_length_total,] %>%
    dplyr::select(estimate) %>%
    as.matrix()

  abund_beta_strata_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", se = T, transform = NULL)[((abund_length) + 1):abund_length_total,] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from all models 
```{r Model averaging abundance models: term estimates}
abund_modavg_beta_intercept_list <- list()
abund_modavg_beta_strata_list <- list()

abund_modavg_beta_intercept_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund_beta_intercept)),
  Uncond.SE = rep(NA, nrow(abund_beta_intercept)),
  Lower.CL = rep(NA, nrow(abund_beta_intercept)),
  Upper.CL = rep(NA, nrow(abund_beta_intercept)))

abund_modavg_beta_strata_matrix <- abund_modavg_beta_intercept_matrix

for(i in 1:nrow(abund_beta_intercept)){
  abund_modavg_beta_intercept_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                                       K = abund_aictab$K, 
                                                       estimate = abund_beta_intercept[i,],
                                                       se = abund_beta_intercept_se[i,],
                                                       nobs = nrow(abund))
  abund_modavg_beta_intercept_matrix$Mod.avg.est[i] <- abund_modavg_beta_intercept_list[[i]]$Mod.avg.est
  abund_modavg_beta_intercept_matrix$Uncond.SE [i] <- abund_modavg_beta_intercept_list[[i]]$Uncond.SE
  abund_modavg_beta_intercept_matrix$Lower.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Lower.CL
  abund_modavg_beta_intercept_matrix$Upper.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Upper.CL
  
  abund_modavg_beta_strata_list[[i]] <- modavgCustom(logL = abund_aictab$LL,
                                                    K = abund_aictab$K,
                                                    estimate = abund_beta_strata[i,],
                                                    se = abund_beta_strata_se[i,],
                                                    nobs = nrow(abund))
  abund_modavg_beta_strata_matrix$Mod.avg.est[i] <- abund_modavg_beta_strata_list[[i]]$Mod.avg.est
  abund_modavg_beta_strata_matrix$Uncond.SE [i] <- abund_modavg_beta_strata_list[[i]]$Uncond.SE
  abund_modavg_beta_strata_matrix$Lower.CL[i] <- abund_modavg_beta_strata_list[[i]]$Lower.CL
  abund_modavg_beta_strata_matrix$Upper.CL[i] <- abund_modavg_beta_strata_list[[i]]$Upper.CL
}

modavg_estimates_abund <- bind_rows(abund_modavg_beta_intercept_matrix,abund_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

modavg_estimates_abund$link <- model_estimates_abund$term
modavg_estimates_abund$facet <- model_estimates_abund$facet
```


### Model averaged predictions of expected values
## From Marc Mazerolle: 
## To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

#### Doing what Marc said ^
```{r Model averaging abundance models: predictions}
abund_pred_fit <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))
abund_pred_se <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))

new_abund <- abund %>%
  mutate(weight = max(weight))

for(i in 1:length(mods_abund)){
  abund_pred_fit[,i] <- predict(mods_abund[[i]], newdata = new_abund, se.fit = T, type = "response")$fit
  abund_pred_se[,i] <- predict(mods_abund[[i]], newdata = new_abund, se.fit = T, type = "response")$se.fit
}

abund_modavg_preds_list <- list()

abund_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund)),
  Uncond.SE = rep(NA, nrow(abund)),
  Lower.CL = rep(NA, nrow(abund)),
  Upper.CL = rep(NA, nrow(abund)))

for(i in 1:nrow(abund_pred_fit)){
  abund_modavg_preds_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                               K = abund_aictab$K, 
                                               estimate = abund_pred_fit[i,], 
                                               se = abund_pred_se[i,],
                                               nobs = nrow(abund_pred_fit))
  abund_modavg_preds_matrix$Mod.avg.est[i] <- abund_modavg_preds_list[[i]]$Mod.avg.est
  abund_modavg_preds_matrix$Uncond.SE[i] <- abund_modavg_preds_list[[i]]$Uncond.SE
  abund_modavg_preds_matrix$Lower.CL[i] <- abund_modavg_preds_list[[i]]$Lower.CL
  abund_modavg_preds_matrix$Upper.CL[i] <- abund_modavg_preds_list[[i]]$Upper.CL
}
```

### Getting data ready for plotting
```{r Model averaging abundance models: preparing data for plotting}
abund$predictions_fit <- abund_modavg_preds_matrix$Mod.avg.est
abund$predictions_se.fit <- abund_modavg_preds_matrix$Uncond.SE
abund$predictions_95CI_lower <- abund_modavg_preds_matrix$Lower.CL
abund$predictions_95CI_upper <- abund_modavg_preds_matrix$Upper.CL
abund$predictions_95CI_lower[abund$predictions_95CI_lower < 0] <- 0
abund$predictions_95CI_upper[abund$predictions_95CI_upper > 1] <- 1

(taxa_link_abund <- abund %>% 
  dplyr::group_by(taxa_order,link,continent,method) %>%
  dplyr::summarise(mean_elevation = mean(elevation),
                   canopy_height = mean(canopy_height),
                   mean_latitude = mean(latitude)) %>%
  dplyr::full_join(modavg_estimates_abund, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58))

abundance_intercept <- "Abundance at lowest strata"
abundance_slope <- "Change in abundance with increasing strata"
taxa_link_abund$facet[taxa_link_abund$facet == "link (Intercept)"] <- abundance_intercept
taxa_link_abund$facet[taxa_link_abund$facet == "strata"] <- abundance_slope

taxa_link_abund_order <- taxa_link_abund %>%
  dplyr::group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T)

taxa_link_abund_order$order <- rep(NA, nrow(taxa_link_abund))
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept])
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope])

taxa_link_abund_avg <- taxa_link_abund_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_abund_avg$order <- rep(NA, nrow(taxa_link_abund_avg))
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept])
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope])

(taxa_link_abund_order_slope <- taxa_link_abund_order %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_abund_avg_slope <- taxa_link_abund_avg %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plotting abundance data}
ggplot(abund, aes(y = predictions_fit, x = strata,
                 ymin = predictions_95CI_lower, 
                 ymax = predictions_95CI_upper,
                 fill = taxa_order, group = link)) + 
  ylab("Predicted species abundance") + xlab("Mean strata height measure") +
  ggtitle("                                                            Abundance") +
  geom_line(size = 1, alpha = 0.3) +
  geom_ribbon(color = NA, alpha = 0.2) +
  scale_fill_viridis_d("Taxa") +
  facet_grid(rows = vars(taxa), cols = vars(continent)) + theme_bw() + 
  theme(legend.position = "bottom");
ggsave("analysis/figures/abundance_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(abund, aes(y = predictions_fit, x = canopy_height)) + geom_point() +
  ylab("Predicted species abundance") + xlab("canopy_height") +
  ggtitle("                                                            Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_grid(rows = vars(taxa), cols = vars(continent)) + theme_bw() + 
  theme(legend.position = "bottom");
ggsave("analysis/figures/abundance_strata_canopy_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(abund, aes(y = predictions_fit, x = latitude)) + geom_point() +
  ylab("Predicted species abundance") + xlab("latitude") +
  ggtitle("                                                            Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_grid(rows = vars(taxa), cols = vars(continent)) + theme_bw() + 
  theme(legend.position = "bottom");
ggsave("analysis/figures/coef_abund_height_latitude.jpeg", width = 8, height = 6, units = "in", dpi = 300)



ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = abs(mean_latitude), col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Absolute Latitude") +
  ggtitle("Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_abund_height_lat.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = mean_elevation, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Elevation") +
  ggtitle("Abundance") +
  scale_fill_viridis_d(name = "Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_abund_height_elv.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = canopy_height, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Canopy Height") +
  ggtitle("Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/coef_abund_height_canopy.jpeg", width = 8, height = 6, units = "in", dpi = 300)
```

## Plot study coef with elevation
```{r}
taxa_link_abund_slope <- taxa_link_abund_order %>%
  filter(facet == "Change in abundance with increasing strata")

ggplot(taxa_link_abund_slope, aes(x = mean_elevation, y = estimate, col = taxa_order)) + 
  ylab("Coef (Abund ~ Height)") + xlab("Elevation") + geom_point() +
  geom_smooth(method = "glm") +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_abund_height.jpeg")

ggplot(taxa_link_abund_slope, aes(x = method, y = estimate, fill = taxa_order)) + 
  ylab("Coef (Abundance ~ Height)") + xlab("Method") + 
  geom_boxplot() + geom_jitter() +
  facet_wrap(~taxa_order, scales = "free") + 
  scale_color_viridis_d("Taxa") + theme_bw() + 
  theme(legend.position = "none")
ggsave("analysis/figures/coef_abund_height_method.jpeg")
```

## Plotting slopes of abundance and richness
```{r Plotting slopes of abundance and richness}
taxa_link_slope <- bind_rows(
  tibble::tibble(taxa_link_abund_order_slope, metric = "abundance"), 
  tibble::tibble(taxa_link_rich_order_slope, metric = "richness")) %>%
  dplyr::select(!c(facet, `factor(...)`, continent, order)) %>%
  dplyr::group_by(taxa_order = factor(taxa_order, levels = c("Bats","Birds","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T) 

taxa_link_slope_rich <- taxa_link_slope %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich$order <- rev(taxa_link_slope_rich$order)
taxa_link_slope_abund <- taxa_link_slope %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund$order <- rev(taxa_link_slope_abund$order)

# Averaging estimates to the taxa level
(taxa_link_slope_avg <- taxa_link_slope %>%
    dplyr::select(taxa_order, estimate, se, CI_95_lower, CI_95_upper, CI_99_lower, CI_99_upper, CI_80_lower, CI_80_upper, sig, metric) %>%
    dplyr::group_by(metric, taxa_order) %>%
    dplyr::summarise(estimate = mean(estimate),
              CI_95_upper = mean(CI_95_upper),
              CI_95_lower = mean(CI_95_lower),
              CI_80_upper = mean(CI_80_upper),
              CI_80_lower = mean(CI_80_lower),
              CI_99_upper = mean(CI_99_upper),
              CI_99_lower = mean(CI_99_lower)) %>%
    dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
    dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
    dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
    dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                                if_else(sig_95 == "*", "**", 
                                        if_else(sig_80 == "*", "*", "")))))

taxa_link_slope_rich_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich_avg$order <- rev(taxa_link_slope_rich_avg$order)

taxa_link_slope_abund_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund_avg$order <- rev(taxa_link_slope_abund_avg$order)

# reformatting the links to look more like citations
taxa_link_slope_rich_plot <- taxa_link_slope_rich %>% 
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))
taxa_link_slope_abund_plot <- taxa_link_slope_abund %>%
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))

```

### Creating slope estimate figures for both richness and abundance
```{r Creating slope estimate figures for both richness and abundance}
col_2_slope_rich_est_cont <- ggplot(taxa_link_slope_rich, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                   Species Richness") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_rich_plot$order, 
                     labels = taxa_link_slope_rich_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  annotate("text", x = seq(56, 54), y = rep(4.5,3), 
           label = c("  * = 80% CI excludes 0"," ** = 95% CI excludes 0","*** = 99% CI excludes 0"), size = 3) +
  scale_color_viridis_d("Taxa") + theme_classic() +
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"), 
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,0,0,0), "lines")); col_2_slope_rich_est_cont

col_2_slope_abund_est_cont <- ggplot(taxa_link_slope_abund, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                        Abundance") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_abund_plot$order, 
                     labels = taxa_link_slope_abund_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,1,0,0), "lines")); col_2_slope_abund_est_cont

col_2_slope_est_cont <- ggarrange(col_2_slope_rich_est_cont, col_2_slope_abund_est_cont); col_2_slope_est_cont

col_2_slope_rich_avg_cont <- ggplot(taxa_link_slope_rich_avg, 
                               aes(x = factor(taxa_order, levels = c(
                                "Small mammals", "Amphibians", "Birds", "Bats"
                               )), y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats","Birds","Amphibians", "      Small Mammals"))) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = c(.5,-0.1), legend.direction = "horizontal", panel.border = element_rect(colour = "black", fill=NA, size=1), 
        axis.text.x.top = element_text(size = 8), legend.title.align = 0.5,
        axis.ticks.length.x.top = unit(0, "cm"),
        axis.line = element_blank(), plot.margin = unit(c(0,0,0,0), "lines")) + 
  guides(colour = guide_legend(title.position = "top")); col_2_slope_rich_avg_cont

col_2_slope_abund_avg_cont <- ggplot(taxa_link_slope_abund_avg, 
                                aes(x = factor(taxa_order, levels = c(
                                "Small mammals", "Amphibians", "Birds", "Bats"
                               )), y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats", "Birds", "Amphibians", "      Small Mammals"))) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +  scale_color_viridis_d(" ") + theme_classic() + 
  theme(legend.position = "none", panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        legend.text = element_text(color="white"),
        axis.line = element_blank(), plot.margin = unit(c(0,1,0,0), "lines")) + 
  guides(color=guide_legend(override.aes=list(fill="white", col = "white"))); col_2_slope_abund_avg_cont

col_2_slope_avg_cont <- ggarrange(col_2_slope_rich_avg_cont, col_2_slope_abund_avg_cont, common.legend = T, legend = "bottom"); col_2_slope_avg_cont
ggarrange(col_2_slope_est_cont, col_2_slope_avg_cont, nrow = 2, heights = c(6,1.5))
ggsave("analysis/figures/parm_taxa_4_panel.jpeg", width = 10, height = 10, units = "in", dpi = 300)
```

```{r}
taxa_link_biomet_order <- full_join(taxa_link_abund_order,taxa_link_rich_order) %>%
  filter(!facet %in% c("Abundance at lowest strata", "Richness at lowest strata"))

taxa_link_biomet_sum <- taxa_link_biomet_order %>%
  mutate(sign = sign(estimate)) %>%
  group_by(taxa_order, facet) %>%
  dplyr::summarize(pos_sig = sum(sign == 1 & sig == "*"),
                   neg_sig = sum(sign == -1 & sig == "*"))

log((taxa_link_biomet_sum$pos_sig+1)/(taxa_link_biomet_sum$neg_sig+1))

ggplot(taxa_link_biomet_sum, aes(y = log((pos_sig+1)/(neg_sig+1)), x = taxa_order, fill = taxa_order)) + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + ylim(c(-3,1)) +
  geom_bar(stat = "identity") + xlab("Taxa") + 
  ylab(log ~ italic(bgroup("(", over("frequency of positive slopes + 1", "frequency of negative slopes + 1"), ")"))) + 
  facet_wrap(~facet) + 
  scale_x_discrete(labels = c("Bats", "Birds", "Small Mammals", "Amphibians")) +
  scale_fill_viridis_d("Taxa") + theme_bw() + theme(legend.position = "none") 
ggsave("analysis/figures/summary_slopes_taxa_biometric.jpeg", width = 8, height = 4, units = "in", dpi = 300)
```

## Summary statistics for coef(richness ~ height) ~ elevation / canopy height 
```{r}
summary_rich_coef <- list()
summary_rich_coef[[1]] <- lmer(estimate ~ canopy_height + (canopy_height|taxa_order), data = taxa_link_rich_slope)
summary_rich_coef[[2]] <- lmer(estimate ~ mean_elevation + (mean_elevation|taxa_order), data = taxa_link_rich_slope)
summary_rich_coef[[3]] <- lmer(estimate ~ abs(mean_latitude) + (abs(mean_latitude)|taxa_order), data = taxa_link_rich_slope)

summary_abund_coef <- list()
summary_abund_coef[[1]] <- lmer(estimate ~ canopy_height + (canopy_height|taxa_order), data = taxa_link_abund_slope)
summary_abund_coef[[2]] <- lmer(estimate ~ mean_elevation + (mean_elevation|taxa_order), data = taxa_link_abund_slope)
summary_abund_coef[[3]] <- lmer(estimate ~ abs(mean_latitude) + (abs(mean_latitude)|taxa_order), data = taxa_link_abund_slope)

summary_coef_re_rbind <- rbind(
  sjPlot::get_model_data(summary_rich_coef[[1]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)"),
  sjPlot::get_model_data(summary_rich_coef[[2]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)"),
  sjPlot::get_model_data(summary_rich_coef[[3]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)"),
    sjPlot::get_model_data(summary_abund_coef[[1]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)"),
  sjPlot::get_model_data(summary_abund_coef[[2]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)"),
  sjPlot::get_model_data(summary_abund_coef[[3]], type = "re", se = T, transform = NULL) %>%
    filter(!facet == "taxa_order (Intercept)")) %>%
  mutate(metric = c(rep("species_richness", 4*3),
                    rep("abundance", 4*3))) %>%
  dplyr::mutate(sig = if_else(sign(conf.low) == sign(conf.high), "*", "")) %>%
  dplyr::select(-c("p.label","xpos","title","xmin","xmax","conf.low","conf.high","group","reihe")) %>%
  relocate(metric) %>%
  pivot_wider(names_from = facet, values_from = c(estimate, sig))

write_csv(summary_coef_re_rbind, "summary_coef_re.csv")
```