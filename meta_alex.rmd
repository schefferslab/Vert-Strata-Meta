---
title: "Modeling biodiversity metrics"
author: "Alex Baecher & Ed Basham"
date: "12/18/2020"
output:
  pdf_document: default
---

# Preparing workspace
## Calling libraries

```{r load packages, message=TRUE, warning=TRUE}
devtools::source_url("https://raw.githubusercontent.com/slamander/load_packages/main/prepare_libraries.R", sha1 = "609d531a319fcd855804de6bdcfe737cd6515332")

packages <- c("lme4",
              "AICcmodavg",
              "glmmTMB",
              "TMB",
              "emmeans",
              "tidyverse",
              "readr",
              "scales",
              "formula.tools",
              "sjPlot",
              "ggpubr",
              "Hmisc",
              "visreg",
              "bbmle")

prepare_libraries(packages)
```

## Loading data
```{r loading data}
dat <- read_csv("data/stripped_data/final/data_joined.csv") %>%
  dplyr::filter(taxa != "All mammals") %>%
  dplyr::filter(taxa != "Primates") %>%
  dplyr::mutate(weight = spatial_rank + temporal_bredth_rank + temporal_resolution_rank,
                taxa = as.factor(taxa),
                taxa_order = factor(taxa, levels = c("Birds","Bats","Small mammals","Amphibians")),
                elevation = as.numeric(scale(elevation)),
                scaled_met = as.numeric(corrected_biodiversity_metric_value),
                link = as.factor(link), 
                method = as.factor(method), 
                bin_weight = bin_weight/mean(bin_weight),
                treatment = as.factor(treatment),
                continent = as.factor(continent),
                biodiversity_metric = as.factor(biodiversity_metric), 
                season = as.factor(season), 
                forest_type_iucn = as.factor(forest_type_iucn_new),  
                mean_strata_height_p = as.numeric(scale(mean_strata_height_p)),
                canopy_height = as.numeric(scale(canopy_height)),
                latitude = as.numeric(latitude),
                longitude = as.numeric(longitude),
                strata = as.numeric(scale(mean_strata_height_p))) %>%
  dplyr::select(link, study_id.x, method, taxa, bin_weight, weight, continent, 
                biodiversity_metric, taxa_order, treatment, season, forest_type_iucn, 
                elevation, canopy_height, latitude, longitude, scaled_met, strata) %>%
  dplyr::select(-c(study_id.x)) %>%
  dplyr::mutate(forest_type_iucn = recode(forest_type_iucn, "dry forest" = "dry_forest"))

abund <- dat %>%
  dplyr::filter(biodiversity_metric == "abundance") %>%
  mutate(latitude = scale(abs(latitude)),
         longitude = scale(as.numeric(longitude)))

rich <- dat %>% 
  dplyr::filter(biodiversity_metric == "richness") %>%
  mutate(latitude = scale(abs(latitude)),
         longitude = scale(as.numeric(longitude)))
```


# Modeling species richness
## Richness GLMs

```{r}
model_formulas_ch <- list("scaled_met ~ 1 +                                                             weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa +                                    weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa +                                    weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa +                                    weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + continent +                        weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + continent +                        weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + continent +                        weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + elevation +                        weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + elevation +                        weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + elevation +                        weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + latitude +                         weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + latitude +                         weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + latitude +                         weight + (strata | link)",
                          
                          # "scaled_met ~ strata +              taxa + longitude +                        weight + (strata | link)",
                          # "scaled_met ~ poly(strata, 2) +     taxa + longitude +                        weight + (strata | link)",
                          # "scaled_met ~ poly(strata, 3) +     taxa + longitude +                        weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + canopy_height +                    weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + canopy_height +                    weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + canopy_height +                    weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + forest_type_iucn +                 weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + forest_type_iucn +                 weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + forest_type_iucn +                 weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + season +                           weight + (strata | link)",
                          "scaled_met ~ poly(strata, 2) +     taxa + season +                           weight + (strata | link)",
                          "scaled_met ~ poly(strata, 3) +     taxa + season +                           weight + (strata | link)",
                          
                          "scaled_met ~ strata +              taxa + continent +        canopy_height + weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + latitude +         canopy_height + weight + (strata | link)",

                          # "scaled_met ~ strata +              taxa + longitude +        canopy_height + weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + season +           canopy_height + weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + forest_type_iucn + canopy_height + weight + (strata | link)",

                          "scaled_met ~ strata +              taxa + continent +        elevation +     weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + canopy_height +    elevation +     weight + (strata | link)",
                          # "scaled_met ~ strata +              taxa + longitude +        elevation +     weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + season +           elevation +     weight + (strata | link)",
                          "scaled_met ~ strata +              taxa + forest_type_iucn + elevation +     weight + (strata | link)")

```


```{r}
glmmTMB(scaled_met ~ strata + taxa + (strata | link), family = beta_family(link = "logit"), weights = bin_weight, REML = F, data = rich)
glmmTMB(scaled_met ~ strata + taxa + (strata | link), family = beta_family(link = "logit"), 
          weights = bin_weight, 
          REML = F,
          data = rich)
```


## Running models 
```{r Creating models}
model_formulas <- lapply(paste(model_formulas_ch), as.formula)

mods_rich <- lapply(model_formulas, function(x){      # using lappy, instead of for loops 
  glmmTMB(x, family = beta_family(link = "logit"), 
          weights = bin_weight, 
          REML = F,
          data = rich)
  })

rich_aictab <- aictab(cand.set = mods_rich, modnames = unlist(model_formulas_ch)); rich_aictab
```

## Model predictions
### Getting model esimates from top model using `sjPlot::get_model_data`
```{r Modeling species richness: esimates from top model}
top_rich_mod <- mods_rich[[as.numeric(str_extract(aictab(mods_rich)[1,1], "(\\d)+"))]] # Identifying top ranked model (automated)

model_estimates_rich <- sjPlot::get_model_data(top_rich_mod, type = "re", se = T, transform = NULL) # Extracting model estimates
```

### Getting model estimates from each richness model using `sjPlot::get_model_data`
```{r Modeling species richness: getting model averaged estimates}
# Creating matrices for model predictions; 4 matrices, each with 53 rows (for each study) and 34 cols (for each model)
## 4 matrices:
rich_length_total <- nrow(sjPlot::get_model_data(top_rich_mod, type = "re", se = T, transform = NULL))
rich_length <- rich_length_total/2

rich_beta_intercept <- matrix(NA, nrow = rich_length, ncol = length(mods_rich))
### 2) Intercept uncertainty
rich_beta_intercept_se <- rich_beta_intercept
### 3) Slope
rich_beta_strata <- rich_beta_intercept
### 4) Slope uncertainty
rich_beta_strata_se <- rich_beta_intercept

## Extracting model estimates with `sjPlot::get_model_data`
for(i in 1:length(mods_rich)){
  ### 1) Intercept
  rich_beta_intercept[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", 
                                                    se = T, transform = NULL)[1:(rich_length),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 2) Intercept uncertainty
  rich_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", 
                                                       se = T, transform = NULL)[1:(rich_length),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
  ### 3) Slope
  rich_beta_strata[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", 
                                                 se = T, transform = NULL)[((rich_length)+1):(rich_length_total),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  ### 4) Slope uncertainty
  rich_beta_strata_se[,i] <- sjPlot::get_model_data(mods_rich[[i]], type = "re", 
                                                    se = T, transform = NULL)[((rich_length)+1):(rich_length_total),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from `glmmTMB` class models using `AICcmodavg::modavgCustom`, a customized function for manual model averaging 
```{r Getting richness model estimates: model averaging model estimates, message=FALSE, warning=FALSE}
# Initializing list for intercepts and slopes
rich_modavg_beta_intercept_list <- list() 
rich_modavg_beta_strata_list <- list() 

# Initializing data.frame for model averaged estimates of intercepts
rich_modavg_beta_intercept_matrix <- tibble(     
  Mod.avg.est = rep(NA, nrow(rich_beta_intercept)), # point estimates
  Uncond.SE = rep(NA, nrow(rich_beta_intercept)),   # unconditional uncertainty estimates
  Lower.CL = rep(NA, nrow(rich_beta_intercept)), # lower 95% confidence interval
  Upper.CL = rep(NA, nrow(rich_beta_intercept))) # upper95% confidence interval

# Initializing data.frame for model averaged estimates of slopes
rich_modavg_beta_strata_matrix <- rich_modavg_beta_intercept_matrix

# `AICcmodavg::modavgCustom` can only extract one point estimate for a number of models at a time, so we're looping over every term (across each model)
for(i in 1:nrow(rich_beta_intercept)){                                                     # this function takes the following data:
  rich_modavg_beta_intercept_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,  # log likelihood (LL)
                                                       K = rich_aictab$K, #                # number of terms in each model (K)
                                                       estimate = rich_beta_intercept[i,], # point estimate of each term 
                                                       se = rich_beta_intercept_se[i,],    # uncertainty for each term 
                                                       nobs = nrow(rich))                  # number of observations in each model (to compute degrees of freedom)
  # moving model estimates into the above data.frame
  rich_modavg_beta_intercept_matrix$Mod.avg.est[i] <- rich_modavg_beta_intercept_list[[i]]$Mod.avg.est 
  rich_modavg_beta_intercept_matrix$Uncond.SE[i] <- rich_modavg_beta_intercept_list[[i]]$Uncond.SE
  rich_modavg_beta_intercept_matrix$Lower.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Lower.CL
  rich_modavg_beta_intercept_matrix$Upper.CL[i] <- rich_modavg_beta_intercept_list[[i]]$Upper.CL
  
  # repeat for slopes
  rich_modavg_beta_strata_list[[i]] <- AICcmodavg::modavgCustom(logL = rich_aictab$LL,
                                                    K = rich_aictab$K,
                                                    estimate = rich_beta_strata[i,],
                                                    se = rich_beta_strata_se[i,],
                                                    nobs = nrow(rich))
  rich_modavg_beta_strata_matrix$Mod.avg.est[i] <- rich_modavg_beta_strata_list[[i]]$Mod.avg.est
  rich_modavg_beta_strata_matrix$Uncond.SE [i] <- rich_modavg_beta_strata_list[[i]]$Uncond.SE
  rich_modavg_beta_strata_matrix$Lower.CL[i] <- rich_modavg_beta_strata_list[[i]]$Lower.CL
  rich_modavg_beta_strata_matrix$Upper.CL[i] <- rich_modavg_beta_strata_list[[i]]$Upper.CL
}

# Combining intercept and slope estimates into single data.frame
modavg_estimates_rich <- bind_rows(rich_modavg_beta_intercept_matrix,rich_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

# Linking movel term names and facet (a factor for the term type, intercept or slope)
modavg_estimates_rich$link <- model_estimates_rich$term

modavg_estimates_rich$facet <- model_estimates_rich$facet

```


### Model averaged predictions of expected values
#### From Marc Mazerolle: 
##### To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

### Doing what Marc said above to obtain model averaged predictions using `stats::predict`, a customized function for manual model averaging 
```{r Model averaging richness model estimates: model averaged predictions, message=FALSE, warning=FALSE}
# Initializing matrices for model averaged predictions 
rich_pred_fit <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))
rich_pred_se <- matrix(NA, nrow = nrow(rich), ncol = length(mods_rich))

new_rich <- rich %>%
  mutate(weight = max(weight))

# Obtaining predictions from each model
for(i in 1:length(mods_rich)){
  rich_pred_fit[,i] <- predict(mods_rich[[i]], se.fit = T, newdata = new_rich, type = "response")$fit
  rich_pred_se[,i] <- predict(mods_rich[[i]], se.fit = T, newdata = new_rich, type = "response")$se.fit
}

# Initializing a list for predictions from each model
rich_modavg_preds_list <- list()

# Initializing a data.frame to load model averaged estimates 
rich_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(rich)),
  Uncond.SE = rep(NA, nrow(rich)),
  Lower.CL = rep(NA, nrow(rich)),
  Upper.CL = rep(NA, nrow(rich)))

# The customized model averaging function also has to work one point prediction at a time, so here we loop over each point estimate across all models 
for(i in 1:nrow(rich_pred_fit)){
  rich_modavg_preds_list[[i]] <- modavgCustom(logL = rich_aictab$LL, 
                                              K = rich_aictab$K, 
                                              estimate = rich_pred_fit[i,], 
                                              se = rich_pred_se[i,],
                                              nobs = nrow(rich_pred_fit))
  rich_modavg_preds_matrix$Mod.avg.est[i] <- rich_modavg_preds_list[[i]]$Mod.avg.est
  rich_modavg_preds_matrix$Uncond.SE [i] <- rich_modavg_preds_list[[i]]$Uncond.SE
  rich_modavg_preds_matrix$Lower.CL[i] <- rich_modavg_preds_list[[i]]$Lower.CL
  rich_modavg_preds_matrix$Upper.CL[i] <- rich_modavg_preds_list[[i]]$Upper.CL
}
```

### Putting model estimates and predictions into something useful for plotting
```{r Model averaged richness predictions: shaping estimates and predictions}
rich$predictions_fit <- rich_modavg_preds_matrix$Mod.avg.est
rich$predictions_se.fit <- rich_modavg_preds_matrix$Uncond.SE
rich$predictions_95CI_lower <- rich_modavg_preds_matrix$Lower.CL
rich$predictions_95CI_upper <- rich_modavg_preds_matrix$Upper.CL
rich$predictions_95CI_lower[rich$predictions_95CI_lower < 0] <- 0
rich$predictions_95CI_upper[rich$predictions_95CI_upper > 1] <- 1

taxa_link_rich <- rich %>% 
  dplyr::group_by(taxa_order,link,continent,method,season,forest_type_iucn) %>%
  dplyr::summarise(mean_elevation = mean(elevation),
                   mean_latitude = mean(latitude),
                   canopy_height = mean(canopy_height)) %>%
  dplyr::full_join(modavg_estimates_rich, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58)

richness_intercept <- "Richness at lowest strata"
richness_slope <- "Change in richness with increasing strata"
taxa_link_rich$facet[taxa_link_rich$facet == "link (Intercept)"] <- richness_intercept
taxa_link_rich$facet[taxa_link_rich$facet == "strata"] <- richness_slope

taxa_link_rich_order <- taxa_link_rich %>%
  group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  arrange(estimate, .by_group = T)

taxa_link_rich_order$order <- rep(NA, nrow(taxa_link_rich))
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_intercept])
taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope] <- 
  1:length(taxa_link_rich_order$order[taxa_link_rich_order$facet == richness_slope])

taxa_link_rich_avg <- taxa_link_rich_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_rich_avg$order <- rep(NA, nrow(taxa_link_rich_avg))
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_intercept])
taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope] <- 
  1:length(taxa_link_rich_avg$order[taxa_link_rich_avg$facet == richness_slope])

(taxa_link_rich_order_slope <- taxa_link_rich_order %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_rich_avg_slope <- taxa_link_rich_avg %>%
  dplyr::filter(facet == richness_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plotting richness predictions}
ggplot(rich, aes(y = predictions_fit, x = strata,
                  ymin = predictions_95CI_lower, 
                  ymax = predictions_95CI_upper,
                  fill = taxa_order, group = link)) + 
  ylab("Predicted species richness") + xlab("Mean strata height measure") +
  ggtitle("                                                               Richness") +
  geom_line(size = 1, alpha = 0.3) +
  geom_ribbon(color = NA, alpha = 0.2) +
  scale_fill_viridis_d("Taxa") +
  facet_grid(cols = vars(taxa), rows = vars(continent)) + theme_bw() +
  theme_bw() + theme(legend.position = "bottom")
ggsave("analysis/figures/model results/richness_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = abs(mean_latitude), col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Absolute Latitude") +
  ggtitle("Species Richness") +
  scale_color_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_rich_height_lat.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = mean_elevation, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Elevation") +
  ggtitle("Species Richness") +
  scale_color_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_rich_height_elv.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_rich_order %>% filter(facet == "Change in richness with increasing strata"), 
       aes(y = estimate, x = canopy_height, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(richness ~ height)") + xlab("Canopy Height") +
  ggtitle("Species Richness") +
  scale_color_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_rich_height_canopy.jpeg", width = 8, height = 6, units = "in", dpi = 300)

```

# Modeling abundance
## Abundance GLMs
```{r Modeling abundance: GLMs, message=FALSE, warning=FALSE}
mods_abund <- lapply(model_formulas, function(x){
  glmmTMB(x, family = beta_family(link = "logit"), 
          weights = bin_weight, 
          data = abund)
  })

abund_aictab <- aictab(cand.set = mods_abund, modnames = unlist(model_formulas_ch)); abund_aictab
```

### Getting model esimates from top abundance model 
```{r Getting abundance model esimates from top model}
top_abund_mod <- mods_abund[[as.numeric(str_extract(aictab(mods_abund)[1,1], "(\\d)+"))]]

model_estimates_abund <- sjPlot::get_model_data(top_abund_mod, type = "re", se = T, transform = NULL)
```

### Getting model estimates from all models 
```{r Getting abundance model esimates from all models}
abund_length_total <- nrow(model_estimates_abund)
abund_length <- abund_length_total/2

abund_beta_intercept <- matrix(NA, nrow = abund_length, ncol = length(mods_abund))
abund_beta_intercept_se <- abund_beta_intercept
abund_beta_strata <- abund_beta_intercept
abund_beta_strata_se <- abund_beta_intercept

for(i in 1:length(mods_abund)){
  abund_beta_intercept[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", 
                                                     se = T, transform = NULL)[1:(abund_length),] %>%
    dplyr::select(estimate) %>%
    as.matrix()
  
  abund_beta_intercept_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", 
                                                        se = T, transform = NULL)[1:(abund_length),] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()

  abund_beta_strata[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", 
                                                  se = T, transform = NULL)[((abund_length) + 1):abund_length_total,] %>%
    dplyr::select(estimate) %>%
    as.matrix()

  abund_beta_strata_se[,i] <- sjPlot::get_model_data(mods_abund[[i]], type = "re", 
                                                     se = T, transform = NULL)[((abund_length) + 1):abund_length_total,] %>%
    dplyr::select(estimate, conf.low) %>%
    dplyr::mutate(se = (estimate - conf.low)/1.96) %>%
    dplyr::select(se) %>% 
    as.matrix()
}
```

### Model averaging model estimates from all models 
```{r Model averaging abundance models: term estimates, message=FALSE, warning=FALSE}
abund_modavg_beta_intercept_list <- list()
abund_modavg_beta_strata_list <- list()

abund_modavg_beta_intercept_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund_beta_intercept)),
  Uncond.SE = rep(NA, nrow(abund_beta_intercept)),
  Lower.CL = rep(NA, nrow(abund_beta_intercept)),
  Upper.CL = rep(NA, nrow(abund_beta_intercept)))

abund_modavg_beta_strata_matrix <- abund_modavg_beta_intercept_matrix

for(i in 1:nrow(abund_beta_intercept)){
  abund_modavg_beta_intercept_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                                       K = abund_aictab$K, 
                                                       estimate = abund_beta_intercept[i,],
                                                       se = abund_beta_intercept_se[i,],
                                                       nobs = nrow(abund))
  abund_modavg_beta_intercept_matrix$Mod.avg.est[i] <- abund_modavg_beta_intercept_list[[i]]$Mod.avg.est
  abund_modavg_beta_intercept_matrix$Uncond.SE [i] <- abund_modavg_beta_intercept_list[[i]]$Uncond.SE
  abund_modavg_beta_intercept_matrix$Lower.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Lower.CL
  abund_modavg_beta_intercept_matrix$Upper.CL[i] <- abund_modavg_beta_intercept_list[[i]]$Upper.CL
  
  abund_modavg_beta_strata_list[[i]] <- modavgCustom(logL = abund_aictab$LL,
                                                    K = abund_aictab$K,
                                                    estimate = abund_beta_strata[i,],
                                                    se = abund_beta_strata_se[i,],
                                                    nobs = nrow(abund))
  abund_modavg_beta_strata_matrix$Mod.avg.est[i] <- abund_modavg_beta_strata_list[[i]]$Mod.avg.est
  abund_modavg_beta_strata_matrix$Uncond.SE [i] <- abund_modavg_beta_strata_list[[i]]$Uncond.SE
  abund_modavg_beta_strata_matrix$Lower.CL[i] <- abund_modavg_beta_strata_list[[i]]$Lower.CL
  abund_modavg_beta_strata_matrix$Upper.CL[i] <- abund_modavg_beta_strata_list[[i]]$Upper.CL
}

modavg_estimates_abund <- bind_rows(abund_modavg_beta_intercept_matrix,abund_modavg_beta_strata_matrix) %>%
  dplyr::mutate(sig = if_else(sign(Lower.CL) == sign(Upper.CL), "*", ""))

modavg_estimates_abund$link <- model_estimates_abund$term

modavg_estimates_abund$facet <- model_estimates_abund$facet
```


### Model averaged predictions of expected values
## From Marc Mazerolle: 
## To get model averaged predictions from a glmmTMB model:
<!-- If you have predictions with SE's obtained from predict( ), then you could model-average these predictions across different models. To do so, you can use the modavgCustom( ) function which is designed for models that are not yet supported by modavg( ), modavgShrink( ), or modavgPred( ). The modavgCustom( ) function model-averages one prediction at a time. You can check ?modavgCustom( ) for an example. If you have several predictions from each model, you could then use a loop to model-average each prediction successively. To do so, you could create two matrices with nmodel rows x npredictions columns. One of these matrices would hold the predictions from each model and the other would hold the SE's of these predictions. -->

#### Doing what Marc said ^
```{r Model averaging abundance models: predictions, message=FALSE, warning=FALSE}
abund_pred_fit <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))
abund_pred_se <- matrix(NA, nrow = nrow(abund), ncol = length(mods_abund))

new_abund <- abund %>%
  mutate(weight = max(weight))

for(i in 1:length(mods_abund)){
  abund_pred_fit[,i] <- predict(mods_abund[[i]], newdata = new_abund, se.fit = T, type = "response")$fit
  abund_pred_se[,i] <- predict(mods_abund[[i]], newdata = new_abund, se.fit = T, type = "response")$se.fit
}

abund_modavg_preds_list <- list()

abund_modavg_preds_matrix <- tibble(
  Mod.avg.est = rep(NA, nrow(abund)),
  Uncond.SE = rep(NA, nrow(abund)),
  Lower.CL = rep(NA, nrow(abund)),
  Upper.CL = rep(NA, nrow(abund)))

for(i in 1:nrow(abund_pred_fit)){
  abund_modavg_preds_list[[i]] <- modavgCustom(logL = abund_aictab$LL, 
                                               K = abund_aictab$K, 
                                               estimate = abund_pred_fit[i,], 
                                               se = abund_pred_se[i,],
                                               nobs = nrow(abund_pred_fit))
  abund_modavg_preds_matrix$Mod.avg.est[i] <- abund_modavg_preds_list[[i]]$Mod.avg.est
  abund_modavg_preds_matrix$Uncond.SE[i] <- abund_modavg_preds_list[[i]]$Uncond.SE
  abund_modavg_preds_matrix$Lower.CL[i] <- abund_modavg_preds_list[[i]]$Lower.CL
  abund_modavg_preds_matrix$Upper.CL[i] <- abund_modavg_preds_list[[i]]$Upper.CL
}
```

### Getting data ready for plotting
```{r Model averaging abundance models: preparing data for plotting}
abund$predictions_fit <- abund_modavg_preds_matrix$Mod.avg.est
abund$predictions_se.fit <- abund_modavg_preds_matrix$Uncond.SE
abund$predictions_95CI_lower <- abund_modavg_preds_matrix$Lower.CL
abund$predictions_95CI_upper <- abund_modavg_preds_matrix$Upper.CL
abund$predictions_95CI_lower[abund$predictions_95CI_lower < 0] <- 0
abund$predictions_95CI_upper[abund$predictions_95CI_upper > 1] <- 1

(taxa_link_abund <- abund %>% 
  dplyr::group_by(taxa_order,link,continent,method,season,forest_type_iucn) %>%
  dplyr::summarise(mean_elevation = mean(elevation),
                   canopy_height = mean(canopy_height),
                   mean_latitude = mean(latitude)) %>%
  dplyr::full_join(modavg_estimates_abund, by = c("link")) %>%
  dplyr::rename(CI_95_lower = Lower.CL,
         CI_95_upper = Upper.CL,
         se = Uncond.SE,
         estimate = Mod.avg.est) %>% 
  dplyr::mutate(CI_80_lower = estimate - se*1.28,
         CI_80_upper = estimate + se*1.28) %>%
  dplyr::mutate(CI_99_lower = estimate - se*2.58,
         CI_99_upper = estimate + se*2.58))

abundance_intercept <- "Abundance at lowest strata"
abundance_slope <- "Change in abundance with increasing strata"
taxa_link_abund$facet[taxa_link_abund$facet == "link (Intercept)"] <- abundance_intercept
taxa_link_abund$facet[taxa_link_abund$facet == "strata"] <- abundance_slope

taxa_link_abund_order <- taxa_link_abund %>%
  dplyr::group_by(facet, factor(taxa_order, levels = c("Birds","Bats","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T)

taxa_link_abund_order$order <- rep(NA, nrow(taxa_link_abund))
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_intercept])
taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope] <- 
  1:length(taxa_link_abund_order$order[taxa_link_abund_order$facet == abundance_slope])

taxa_link_abund_avg <- taxa_link_abund_order %>%
  dplyr::group_by(taxa_order, facet) %>%
  dplyr::summarise(estimate = mean(estimate),
          CI_95_upper = mean(CI_95_upper),
          CI_95_lower = mean(CI_95_lower),
          CI_80_upper = mean(CI_80_upper),
          CI_80_lower = mean(CI_80_lower),
          CI_99_upper = mean(CI_99_upper),
          CI_99_lower = mean(CI_99_lower))

taxa_link_abund_avg$order <- rep(NA, nrow(taxa_link_abund_avg))
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_intercept])
taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope] <- 
  1:length(taxa_link_abund_avg$order[taxa_link_abund_avg$facet == abundance_slope])

(taxa_link_abund_order_slope <- taxa_link_abund_order %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))

(taxa_link_abund_avg_slope <- taxa_link_abund_avg %>%
  dplyr::filter(facet == abundance_slope) %>%
  dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
  dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                              if_else(sig_95 == "*", "**", 
                                      if_else(sig_80 == "*", "*", "")))))
```

### Plot predictions
```{r Plotting abundance data}
ggplot(abund, aes(y = predictions_fit, x = strata,
                 ymin = predictions_95CI_lower, 
                 ymax = predictions_95CI_upper,
                 fill = taxa_order, group = link)) + 
  ylab("Predicted species abundance") + xlab("Mean strata height measure") +
  ggtitle("                                                            Abundance") +
  geom_line(size = 1, alpha = 0.3) +
  geom_ribbon(color = NA, alpha = 0.2) +
  scale_fill_viridis_d("Taxa") +
  facet_grid(rows = vars(taxa), cols = vars(continent)) + theme_bw() + 
  theme(legend.position = "bottom");
ggsave("analysis/figures/model results/abundance_strata_full_continent.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = abs(mean_latitude), col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Absolute Latitude") +
  ggtitle("Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_abund_height_lat.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = mean_elevation, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Elevation") +
  ggtitle("Abundance") +
  scale_fill_viridis_d(name = "Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_abund_height_elv.jpeg", width = 8, height = 6, units = "in", dpi = 300)

ggplot(taxa_link_abund_order %>% filter(facet == "Change in abundance with increasing strata"), 
       aes(y = estimate, x = canopy_height, col = taxa_order)) + 
  geom_point() + geom_smooth(method = "glm") +
  ylab("Coef(abundance ~ height)") + xlab("Canopy Height") +
  ggtitle("Abundance") +
  scale_fill_viridis_d("Taxa") +
  facet_wrap(~taxa_order, scales = "free") +
  theme(legend.position = "bottom") + theme_bw()
ggsave("analysis/figures/model results/coef_abund_height_canopy.jpeg", width = 8, height = 6, units = "in", dpi = 300)
```

## Plotting slopes of abundance and richness
```{r Plotting slopes of abundance and richness}
taxa_link_slope <- bind_rows(
  tibble::tibble(taxa_link_abund_order_slope, metric = "abundance"), 
  tibble::tibble(taxa_link_rich_order_slope, metric = "richness")) %>%
  dplyr::select(!c(facet, `factor(...)`, continent, order)) %>%
  dplyr::group_by(taxa_order = factor(taxa_order, levels = c("Bats","Birds","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T) 

taxa_link_slope_rich <- taxa_link_slope %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich$order <- rev(taxa_link_slope_rich$order)
taxa_link_slope_abund <- taxa_link_slope %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund$order <- rev(taxa_link_slope_abund$order)

# Averaging estimates to the taxa level
(taxa_link_slope_avg <- taxa_link_slope %>%
    dplyr::select(taxa_order, estimate, se, CI_95_lower, CI_95_upper, CI_99_lower, CI_99_upper, CI_80_lower, CI_80_upper, sig, metric) %>%
    dplyr::group_by(metric, taxa_order) %>%
    dplyr::summarise(estimate = mean(estimate),
              CI_95_upper = mean(CI_95_upper),
              CI_95_lower = mean(CI_95_lower),
              CI_80_upper = mean(CI_80_upper),
              CI_80_lower = mean(CI_80_lower),
              CI_99_upper = mean(CI_99_upper),
              CI_99_lower = mean(CI_99_lower)) %>%
    dplyr::mutate(sig_80 = if_else(sign(CI_80_upper) == sign(CI_80_lower), "*", "")) %>%
    dplyr::mutate(sig_95 = if_else(sign(CI_95_upper) == sign(CI_95_lower), "*", "")) %>%
    dplyr::mutate(sig_99 = if_else(sign(CI_99_upper) == sign(CI_99_lower), "*", "")) %>%
    dplyr::mutate(sig = if_else(sig_99 == "*", "***", 
                                if_else(sig_95 == "*", "**", 
                                        if_else(sig_80 == "*", "*", "")))))

taxa_link_slope_rich_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "richness") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_rich_avg$order <- rev(taxa_link_slope_rich_avg$order)

taxa_link_slope_abund_avg <- taxa_link_slope_avg %>%
  dplyr::filter(metric == "abundance") %>%
  tibble::rowid_to_column("order")
taxa_link_slope_abund_avg$order <- rev(taxa_link_slope_abund_avg$order)

# reformatting the links to look more like citations
taxa_link_slope_rich_plot <- taxa_link_slope_rich %>% 
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))
taxa_link_slope_abund_plot <- taxa_link_slope_abund %>%
  mutate(link_plot = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))

```

### Creating slope estimate figures for both richness and abundance
```{r Creating slope estimate figures for both richness and abundance}
col_2_slope_rich_est_cont <- ggplot(taxa_link_slope_rich, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                      Species Richness") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_rich_plot$order, 
                     labels = taxa_link_slope_rich_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-4.5, 4.5), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  annotate("text", x = seq(59, 57), y = rep(3,3), 
           label = c("  * = 80% CI excludes 0"," ** = 95% CI excludes 0","*** = 99% CI excludes 0"), size = 3) +
  scale_color_viridis_d("Taxa") + theme_classic() +
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"), 
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,0,0,0), "lines")); col_2_slope_rich_est_cont

col_2_slope_abund_est_cont <- ggplot(taxa_link_slope_abund, aes(x = order, y = estimate, col = taxa_order)) + 
  ylab(" ") + xlab(" ") + ggtitle("                         Abundance") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  scale_x_continuous(breaks = taxa_link_slope_abund_plot$order, 
                     labels = taxa_link_slope_abund_plot$link_plot, expand = c(0.02, 0)) +
  scale_y_continuous(limits = c(-4.5, 4.5), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0),
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  geom_text(aes(x = order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = "none", axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line = element_blank(), plot.margin = unit(c(1,1,0,0), "lines")); col_2_slope_abund_est_cont

col_2_slope_est_cont <- ggarrange(col_2_slope_rich_est_cont, col_2_slope_abund_est_cont); col_2_slope_est_cont

col_2_slope_rich_avg_cont <- ggplot(taxa_link_slope_rich_avg, 
                               aes(x = factor(taxa_order, levels = c(
                                "Amphibians", "Small mammals", "Birds", "Bats")), 
                                y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats","Birds","      Small Mammals", "Amphibians"))) +
  scale_y_continuous(limits = c(-4.5, 4.5), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = c(.5,-0.1), legend.direction = "horizontal", panel.border = element_rect(colour = "black", fill=NA, size=1), 
        axis.text.x.top = element_text(size = 8), legend.title.align = 0.5,
        axis.ticks.length.x.top = unit(0, "cm"),
        axis.line = element_blank(), plot.margin = unit(c(0,0,0,0), "lines")) + 
  guides(colour = guide_legend(title.position = "top")); col_2_slope_rich_avg_cont

col_2_slope_abund_avg_cont <- ggplot(taxa_link_slope_abund_avg, 
                                aes(x = factor(taxa_order, levels = c(
                                "Amphibians", "Small mammals", "Birds", "Bats")), 
                                y = estimate, col = taxa_order)) + 
  ylab(expression(Delta ~ "metric with 1% increase in height")) + xlab(" ") + coord_flip() + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + geom_point(size = 1.5) + 
  geom_linerange(aes(ymax = CI_80_upper, 
                     ymin = CI_80_lower), size = 1.1) +
  geom_linerange(aes(ymax = CI_95_upper,
                     ymin = CI_95_lower)) +
  geom_text(aes(x = taxa_order, y = if_else(sign(estimate) == 1, CI_95_upper + 1, CI_95_lower - 1), label = sig), show.legend = F) +
  scale_x_discrete(labels = rev(c("Bats","Birds","      Small Mammals", "Amphibians"))) +
  scale_y_continuous(limits = c(-4.5, 4.5), breaks = seq(-4, 4, by = 2), expand = c(0.05, 0), 
                     sec.axis = sec_axis(~., breaks = c(-2,0,2), labels = c("Decreasing"," ","Increasing"))) +  
  scale_color_viridis_d(" ") + theme_classic() + 
  theme(legend.position = "none", panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.text.x.top = element_text(size = 8),
        axis.ticks.length.x.top = unit(0, "cm"),
        legend.text = element_text(color="white"),
        axis.line = element_blank(), plot.margin = unit(c(0,1,0,0), "lines")) + 
  guides(color=guide_legend(override.aes=list(fill="white", col = "white"))); col_2_slope_abund_avg_cont

col_2_slope_avg_cont <- ggarrange(col_2_slope_rich_avg_cont, col_2_slope_abund_avg_cont, common.legend = T, legend = "bottom"); col_2_slope_avg_cont
ggarrange(col_2_slope_est_cont, col_2_slope_avg_cont, nrow = 2, heights = c(9,2))
ggsave("analysis/figures/model results/parm_taxa_4_panel.jpeg", width = 10, height = 12, units = "in", dpi = 600)
```

```{r}

taxa_link_biomet_order <- full_join(taxa_link_slope_abund, taxa_link_slope_rich)

taxa_link_biomet_sum <- taxa_link_biomet_order %>%
  mutate(sign = sign(estimate)) %>%
  group_by(taxa_order, metric) %>%
  dplyr::summarize(sig_pos_80 = sum(sign == 1 &  sig_80 == "*"),
                   sig_neg_80 = sum(sign == -1 & sig_80 == "*"),
                   sig_pos_95 = sum(sign == 1 &  sig_95 == "*"),
                   sig_neg_95 = sum(sign == -1 & sig_95 == "*"),
                   sig_pos_99 = sum(sign == 1 &  sig_99 == "*"),
                   sig_neg_99 = sum(sign == -1 & sig_99 == "*"))

taxa_link_biomet_sum_80 <- taxa_link_biomet_sum[c("taxa_order", "metric", "sig_pos_80","sig_neg_80")]
taxa_link_biomet_sum_95 <- taxa_link_biomet_sum[c("taxa_order", "metric", "sig_pos_95","sig_neg_95")]
taxa_link_biomet_sum_99 <- taxa_link_biomet_sum[c("taxa_order", "metric", "sig_pos_99","sig_neg_99")]

colnames(taxa_link_biomet_sum_80) <- c("taxa_order", "metric","sig_pos","sig_neg")
colnames(taxa_link_biomet_sum_95) <- c("taxa_order", "metric","sig_pos","sig_neg")
colnames(taxa_link_biomet_sum_99) <- c("taxa_order", "metric","sig_pos","sig_neg")

taxa_link_biomet_sig <- rbind(data.frame(taxa_link_biomet_sum_80, Significance = "80%"),
                              data.frame(taxa_link_biomet_sum_95, Significance = "95%"),
                              data.frame(taxa_link_biomet_sum_99, Significance = "99%"))

taxa_link_biomet_freq <- taxa_link_biomet_sig %>%
  mutate(freq = log((sig_pos + 1)/(sig_neg + 1))) 

taxa_link_biomet_freq$metric[taxa_link_biomet_freq$metric == "richness"] <- "Richness"
taxa_link_biomet_freq$metric[taxa_link_biomet_freq$metric == "abundance"] <- "Abundance"

ggplot(taxa_link_biomet_freq, aes(y = freq, x = factor(taxa_order, levels = c("Bats", "Birds", "Small mammals", "Amphibians")), 
                                 fill = factor(taxa_order, levels = c("Bats", "Birds", "Small mammals", "Amphibians")))) + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + 
  geom_col(position = "identity", aes(alpha = Significance)) + xlab("Taxa") + 
  ylab(log ~ italic(bgroup("(", over("frequency of positive slopes + 1", "frequency of negative slopes + 1"), ")"))) + 
  facet_wrap(~factor(metric, levels = c("Richness","Abundance")), labeller = labeller(richness = "Richness", abundance = "Abundance")) +
  scale_x_discrete(labels = c("Bats", "Birds", "Small mammals", "Amphibians")) +
  scale_fill_viridis_d(" ") + theme_classic() + theme(legend.position = "bottom") + guides(fill = F)
ggsave("analysis/figures/model results/summary_slopes_taxa_biometric.jpeg", width = 8, height = 5, units = "in", dpi = 600)

ggplot(taxa_link_biomet_freq, aes(y = freq, x = factor(taxa_order, levels = c("Bats", "Birds", "Small mammals", "Amphibians")), 
                                 fill = factor(taxa_order, levels = c("Bats", "Birds", "Small mammals", "Amphibians")))) + 
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.8) + 
  geom_col(position = "identity", aes(alpha = Significance)) + xlab("Taxa") + 
  ylab(log ~ italic(bgroup("(", over("frequency of positive slopes + 1", "frequency of negative slopes + 1"), ")"))) + 
  facet_wrap(~factor(metric, levels = c("Richness","Abundance")), labeller = labeller(richness = "Richness", abundance = "Abundance"), nrow = 2) +
  scale_x_discrete(labels = c("Bats", "Birds", "Small mammals", "Amphibians")) +
  scale_fill_viridis_d(" ") + theme_classic() + theme(legend.position = "bottom") + guides(fill = F)
ggsave("analysis/figures/model results/summary_slopes_taxa_biometric_vert.jpeg", width = 5, height = 8, units = "in", dpi = 600)
```


## Analyzing the model coefficients for continuous variables
```{r}
sm_rich_slope    <- subset(taxa_link_rich_order_slope, taxa_order == "Small mammals") # taxa_link_rich_slope not found... 
bat_rich_slope   <- subset(taxa_link_rich_order_slope, taxa_order == "Bats")
bird_rich_slope  <- subset(taxa_link_rich_order_slope, taxa_order == "Birds")
amph_rich_slope  <- subset(taxa_link_rich_order_slope, taxa_order == "Amphibians")
sm_abund_slope   <- subset(taxa_link_rich_order_slope, taxa_order == "Small mammals")
bat_abund_slope  <- subset(taxa_link_rich_order_slope, taxa_order == "Bats")
bird_abund_slope <- subset(taxa_link_rich_order_slope, taxa_order == "Birds")
amph_abund_slope <- subset(taxa_link_rich_order_slope, taxa_order == "Amphibians")

sum_mods_list <- list(
  lm(sm_rich_slope$estimate ~ sm_rich_slope$mean_elevation),
  lm(sm_rich_slope$estimate ~ sm_rich_slope$canopy_height),
  lm(sm_rich_slope$estimate ~ abs(sm_rich_slope$mean_latitude)),
  lm(bat_rich_slope$estimate ~ bat_rich_slope$mean_elevation),
  lm(bat_rich_slope$estimate ~ bat_rich_slope$canopy_height),
  lm(bat_rich_slope$estimate ~ abs(bat_rich_slope$mean_latitude)),
  lm(bird_rich_slope$estimate ~ bird_rich_slope$mean_elevation),
  lm(bird_rich_slope$estimate ~ bird_rich_slope$canopy_height),
  lm(bird_rich_slope$estimate ~ abs(bird_rich_slope$mean_latitude)),
  lm(amph_rich_slope$estimate ~ amph_rich_slope$mean_elevation),
  lm(amph_rich_slope$estimate ~ amph_rich_slope$canopy_height),
  lm(amph_rich_slope$estimate ~ abs(amph_rich_slope$mean_latitude)),
  lm(sm_abund_slope$estimate ~ sm_abund_slope$mean_elevation),
  lm(sm_abund_slope$estimate ~ sm_abund_slope$canopy_height),
  lm(sm_abund_slope$estimate ~ abs(sm_abund_slope$mean_latitude)),
  lm(bat_abund_slope$estimate ~ bat_abund_slope$mean_elevation),
  lm(bat_abund_slope$estimate ~ bat_abund_slope$canopy_height),
  lm(bat_abund_slope$estimate ~ abs(bat_abund_slope$mean_latitude)),
  lm(bird_abund_slope$estimate ~ bird_abund_slope$mean_elevation),
  lm(bird_abund_slope$estimate ~ bird_abund_slope$canopy_height),
  lm(bird_abund_slope$estimate ~ abs(bird_abund_slope$mean_latitude)),
  lm(amph_abund_slope$estimate ~ amph_abund_slope$mean_elevation),
  lm(amph_abund_slope$estimate ~ amph_abund_slope$canopy_height),
  lm(amph_abund_slope$estimate ~ abs(amph_abund_slope$mean_latitude)))

mod_sum <- data.frame(
  metric = rep(c("Richness","Abundance"), each = 12),
  taxa = rep(rep(c("Small mammals", "Bats","Birds" ,"Amphibians"), each = 3), 2),
  variables = rep(rep(c("elevation","canopy height","latitude"),4), 2),
  estimate = unlist(lapply(sum_mods_list, function(x){coef(x)[2]})),
  lower_99_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.99)[2,1]})),
  upper_99_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.99)[2,2]})),
  lower_95_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.95)[2,1]})),
  upper_95_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.95)[2,2]})),
  lower_80_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.80)[2,1]})),
  upper_80_CI = unlist(lapply(sum_mods_list, function(x){confint(x, level = 0.80)[2,2]}))) %>%
  dplyr::mutate(sig_95 = if_else(sign(upper_95_CI) == sign(lower_95_CI), "*", "")) %>%
  dplyr::mutate(sig_99 = if_else(sign(upper_99_CI) == sign(lower_99_CI), "*", "")) %>%
  dplyr::mutate(sig = if_else(sig_99 == "*", "**", 
                              if_else(sig_95 == "*", "*", "")))

mod_sum_rich <- mod_sum %>%
  filter(metric == "Richness") %>%
  dplyr::group_by(variables, taxa = factor(taxa, levels = c("Bats","Birds","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T) 
mod_sum_rich$order <- rep(c(1,2,3,4), 3)

mod_sum_abund <- mod_sum %>%
  filter(metric == "Abundance") %>%
  dplyr::group_by(variables, taxa = factor(taxa, levels = c("Bats","Birds","Small mammals","Amphibians"))) %>%
  dplyr::arrange(estimate, .by_group = T) 
mod_sum_abund$order <- rep(c(1,2,3,4), 3)
```


```{r}
label_95_99 <- data.frame(
  variables = factor("canopy height", levels = c("canopy height","elevation","latitude")),
  order = c(4,3),
  taxa = factor("Birds", levels = c("Bats","Birds","Small mammals","Amphibians")),
  estimate = c(5.3,5.14),
  lab = c("* = 95% CI excludes 0","** = 99% CI excludes 0")
)

mod_sum_rich_pan <- ggplot(mod_sum_rich, aes(x = estimate, y = rev(order), color = taxa)) + 
  ylab(" ") + xlab("Direction of vertical stratification") + 
  ggtitle("                Species Richness") +
  geom_vline(xintercept = 0, alpha = 0.5, size = 0.6) + geom_point(size = 1.5) + 
  geom_linerange(aes(xmax = upper_80_CI, 
                     xmin = lower_80_CI), size = 1.1) +
  geom_linerange(aes(xmax = upper_95_CI,
                     xmin = lower_95_CI)) +
  geom_text(aes(y = rev(order), x = if_else(sign(estimate) == 1, upper_95_CI + 1, lower_95_CI - 1), label = sig), show.legend = F) +
  geom_text(data = label_95_99, label = c("* = 95% CI excludes 0","** = 99% CI excludes 0"), size = 2.5, col = "black") +
  facet_grid(rows = vars(variables)) +
  scale_x_continuous(limits = c(-8, 8), breaks = seq(-8, 8, by = 2),
                     sec.axis = sec_axis(~., breaks = c(-4,0,4), labels = c("Downward","","Upward"))) +
  scale_y_continuous(breaks = c(1,2,3,4),
                     labels = rev(c("Bats","Birds","Small mammals","Amphibians")),
                     expand = c(0.25, 0)) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = "bottom"); mod_sum_rich_pan

mod_sum_abund_pan <- ggplot(mod_sum_abund, aes(x = estimate, y = rev(order), color = taxa)) + 
  ylab(" ") + xlab("Direction of vertical stratification") + 
  ggtitle("                    Abundance") +
  geom_vline(xintercept = 0, alpha = 0.5, size = 0.6) + geom_point(size = 1.5) + 
  geom_linerange(aes(xmax = upper_80_CI, 
                     xmin = lower_80_CI), size = 1.1) +
  geom_linerange(aes(xmax = upper_95_CI,
                     xmin = lower_95_CI)) +
  geom_text(aes(y = rev(order), x = if_else(sign(estimate) == 1, upper_95_CI + 1, lower_95_CI - 1), label = sig), show.legend = F) +
  facet_grid(rows = vars(variables)) +
  scale_x_continuous(limits = c(-8, 8), breaks = seq(-8, 8, by = 2),
                     sec.axis = sec_axis(~., breaks = c(-4,0,4), labels = c("Downward","","Upward"))) +
  scale_y_continuous(breaks = c(1,2,3,4),
                     labels = rev(c("","","","")),
                     expand = c(0.25, 0)) +
  scale_color_viridis_d("Taxa") + theme_classic() + 
  theme(legend.position = "bottom",
        axis.line = element_line(),
        axis.ticks.y = element_blank()); mod_sum_abund_pan

ggarrange(mod_sum_rich_pan, mod_sum_abund_pan, common.legend = T, legend = "bottom", widths = c(1,0.8))

ggsave("analysis/figures/model results/summary_slopes_vars.jpeg", width = 8, height = 4.5, units = "in", dpi = 600)

```

```{r}
sum_mods_cat_list <- list(
  lm(estimate ~ continent,        data = sm_rich_slope),
  lm(estimate ~ season,           data = sm_rich_slope),
  lm(estimate ~ forest_type_iucn, data = sm_rich_slope),
  lm(estimate ~ continent,        data = bat_rich_slope),
  lm(estimate ~ season,           data = bat_rich_slope),
  lm(estimate ~ forest_type_iucn, data = bat_rich_slope),
  lm(estimate ~ continent,        data = bird_rich_slope), #7 *
  lm(estimate ~ season,           data = bird_rich_slope), #8 *
  lm(estimate ~ forest_type_iucn, data = bird_rich_slope), #9 *
  lm(estimate ~ continent,        data = amph_rich_slope),
  lm(estimate ~ season,           data = amph_rich_slope),
  lm(estimate ~ forest_type_iucn, data = amph_rich_slope),
  lm(estimate ~ continent,        data = sm_abund_slope),
  lm(estimate ~ season,           data = sm_abund_slope),
  lm(estimate ~ forest_type_iucn, data = sm_abund_slope), 
  lm(estimate ~ continent,        data = bat_abund_slope), 
  lm(estimate ~ season,           data = bat_abund_slope),
  lm(estimate ~ forest_type_iucn, data = bat_abund_slope),
  lm(estimate ~ continent,        data = bird_abund_slope), #19
  lm(estimate ~ season,           data = bird_abund_slope), #20
  lm(estimate ~ forest_type_iucn, data = bird_abund_slope), #21 *
  lm(estimate ~ continent,        data = amph_abund_slope),
  lm(estimate ~ season,           data = amph_abund_slope),
  lm(estimate ~ forest_type_iucn, data = amph_abund_slope)) 

# Make new table avoiding p-values
mod_cat_sum <- data.frame(
  metric = rep(c("Richness","Abundance"), each = 12),
  taxa = rep(rep(c("Small mammals", "Bats","Birds" ,"Amphibians"), each = 3), 2),
  variables = rep(rep(c("continent","season","forest_type_iucn"),4), 2),
  estimate = unlist(lapply(sum_mods_cat_list, function(x){coef(x)[2]})),
  p_value = unlist(lapply(sum_mods_cat_list, function(x){anova(x)[1,5]})))

write_csv(mod_cat_sum, "analysis/tables/mod_cat_sum.csv")

sig_mods <- which(mod_cat_sum$p_value < 0.05)
contrast_vars <- c("continent", "season", "forest_type_iucn", "forest_type_iucn", "forest_type_iucn")

emmeans::emmeans(sum_mods_cat_list[[sig_mods[1]]], pairwise~"continent")$contrasts
 # contrast                estimate    SE df t.ratio p.value
 #  Africa - Americas             -0.104 0.734 25 -0.142  0.9889 
 #  Africa - Asia and Oceania      1.099 0.749 25  1.467  0.3232 
 #  Americas - Asia and Oceania    1.203 0.387 25  3.111  0.0124 

# Bird richness in the Americas is more upwardly stratified than Asia and Oceania 

emmeans::emmeans(sum_mods_cat_list[[sig_mods[2]]],  pairwise~"season")$contrasts
 # contrast                estimate    SE df t.ratio p.value
 # Dry - Sampling combined    1.346 0.455 25  2.960  0.0176 
 # Dry - Wet                 -0.305 0.498 25 -0.612  0.8148 
 # Sampling combined - Wet   -1.651 0.352 25 -4.687  0.0002 

# sampling combined in less upwardly stratified than data from the wet season 

emmeans::emmeans(sum_mods_cat_list[[sig_mods[3]]],  pairwise~"forest_type_iucn")$contrasts
 # contrast                                    estimate    SE df t.ratio p.value
 # dry_forest - moist_lowland_forest             -0.609 0.481 25 -1.266  0.4268 
 # dry_forest - moist_montane_forest              0.802 0.454 25  1.766  0.2015 
 # moist_lowland_forest - moist_montane_forest    1.411 0.421 25  3.352  0.0070 

# Bird richness in the moist lowland forest is more upwardly stratified than moist montane forest

emmeans::emmeans(sum_mods_cat_list[[sig_mods[4]]], pairwise~"continent")$contrasts
 # contrast                                    estimate    SE df t.ratio p.value
 # Africa - Americas             -0.104 0.734 25 -0.142  0.9889 
 # Africa - Asia and Oceania      1.099 0.749 25  1.467  0.3232 
 # Americas - Asia and Oceania    1.203 0.387 25  3.111  0.0124 

emmeans::emmeans(sum_mods_cat_list[[sig_mods[5]]], pairwise~"season")$contrasts
 # Dry - Sampling combined    1.346 0.455 25  2.960  0.0176 
 # Dry - Wet                 -0.305 0.498 25 -0.612  0.8148 
 # Sampling combined - Wet   -1.651 0.352 25 -4.687  0.0002 

emmeans::emmeans(sum_mods_cat_list[[sig_mods[6]]], pairwise~"forest_type_iucn")$contrasts
 # dry_forest - moist_lowland_forest             -0.609 0.481 25 -1.266  0.4268 
 # dry_forest - moist_montane_forest              0.802 0.454 25  1.766  0.2015 
 # moist_lowland_forest - moist_montane_forest    1.411 0.421 25  3.352  0.0070  

# Bird abundance in the moist lowland forest is more upwardly stratified than moist montane forest
```

###   Now try to select only studies that did both abundance and richness and plot the estimates against one another
```{r}
rich_studies  =  as.data.frame(unique(taxa_link_rich_order_slope$link)) ; colnames(rich_studies) = "link"
abund_studies  =  as.data.frame(unique(taxa_link_rich_order_slope$link)) ; colnames(abund_studies) = "link"
all_studies =  rbind(rich_studies, abund_studies)
all_studies_count = all_studies %>%
  count(link)
studies_matched = subset(all_studies_count, n == 2)

rich_studies_matched = taxa_link_rich_order_slope %>% 
  filter(link %in% studies_matched$link) %>% 
  mutate(estimate_rich = estimate) %>% 
  dplyr::select(taxa_order, link, estimate_rich)

abund_studies_matched = taxa_link_abund_order_slope %>% 
  filter(link %in% studies_matched$link) %>% 
  mutate(estimate_abund = estimate) %>% 
  dplyr::select(taxa_order, link, estimate_abund)

estimates_matched = merge(rich_studies_matched, abund_studies_matched, by = "link")

ggplot(estimates_matched, aes(x = estimate_abund, y = estimate_rich))+
  geom_point(aes(color = taxa_order.x))+
  geom_smooth( method = "lm") +
  geom_abline(slope=1)+
  ylab("Richness Coefficient Estimate") + 
  xlab("Abundance Coefficient Estimate") + 
  coord_fixed(ratio = 1, xlim = c(-2, 2),  ylim = c(-2, 2)) +
  theme(legend.position = "bottom",legend.title = element_blank(),
        axis.line = element_line(),
        axis.ticks.y = element_blank())

  

#bernard , peters, rodriguez , pereira = odd ones out  


ggsave("analysis/figures/study descriptions/abundance_richness_correlation.jpeg", width = 6, height = 4, units = "in", dpi = 600)


```

###   Now making table S1 which has all of the basic meta data for the study units
```{r}

#here pulling in a different set of data columns from data_joined - including the references and things like that 
dat_table <- read_csv("data/stripped_data/final/data_joined.csv") %>%
  dplyr::filter(taxa != "All mammals") %>%
  dplyr::filter(taxa != "Primates") %>%
  dplyr::mutate(weight = spatial_rank + temporal_bredth_rank + temporal_resolution_rank,
                taxa = as.factor(taxa),
                taxa_order = factor(taxa, levels = c("Birds","Bats","Small mammals","Amphibians")),
                elevation = as.numeric(elevation),
                scaled_met = as.numeric(rescale(corrected_biodiversity_metric_value, to = c(0.00001, 0.99999))),
                link = as.factor(link), 
                method = as.factor(method), 
                treatment = as.factor(treatment),
                continent = as.factor(continent),
                biodiversity_metric = as.factor(biodiversity_metric), 
                season = as.factor(season), 
                forest_type_iucn = as.factor(forest_type_iucn_new),  
                mean_strata_height_p = as.numeric(mean_strata_height_p)) %>%
  dplyr::select(link, study_id.x, sites, year, method, taxa, continent, country,biodiversity_metric, reference, taxa_order,
                season,forest_type_iucn, elevation, canopy_height, latitude, longitude, weight,
                scaled_met, strata = mean_strata_height_p) 



tables_S1 = unique(dat_table[,c( "reference","link", "taxa", "method", "weight", "continent" ,"country", "latitude", "longitude", "elevation", "forest_type_iucn", "canopy_height", "season")])


tables_S1 = unique(dat_table[,c( "reference","link", "taxa", 
                                 "weight","continent" ,"latitude", 
                                 "longitude","elevation", 
                                 "forest_type_iucn", "canopy_height", "season")])

tables_S1 = unique(dat_table[,c( "reference","link", "taxa", "method", "weight", "continent" , "latitude", "longitude", "elevation", "forest_type_iucn", "canopy_height", "season")])


#### needing to add if they recorded abundance or richness
rich_studies = as.data.frame(rich_studies) ; rich_studies$richness = "Y"
abund_studies = as.data.frame(abund_studies) ; abund_studies$abund = "Y"

metrics_studies = merge(rich_studies, abund_studies, by = "link", all = T)

## heres the final merge
full_table_S1 =  cbind(tables_S1, metrics_studies[,2:3])

# reformatting the links to look more like citations

full_table_S1 <- full_table_S1 %>% 
  mutate(link = link %>% 
           str_replace("_"," ") %>% 
           str_replace(" _ ",": ") %>%
           str_replace(": 1","") %>%
           str_replace(": 2"," (2)") %>%
           str_replace(": 3"," (3)") %>%
           str_replace(": 4"," (4)") %>%
           str_replace(": 5"," (5)") %>%
           str_replace(": 6"," (6)") %>%
           str_replace(": 7"," (7)") %>%
           str_replace(": 8"," (8)") %>%
           str_replace(": 9"," (9)"))

# rename columns


colnames(full_table_S1) = c( "Study Unit","Reference", "Taxa", "Method", "Study Quality", "Bioregion" ,"Country", "Latitude", "Longitude", "Elevation", "Forest Type", "Canopy Height", "Season", "Richness", "Abundance")


colnames(full_table_S1) = c( "Reference","Study Unit", "Taxa", 
                             "Study Quality", "Bioregion" , 
                             "Latitude", "Longitude", "Elevation", 
                             "Forest Type", "Canopy Height", 
                             "Season", "Richness", "Abundance")

colnames(full_table_S1) = c( "Reference","Study Unit", "Taxa", "Method", "Study Quality", "Bioregion" , "Latitude", "Longitude", "Elevation", "Forest Type", "Canopy Height", "Season", "Richness", "Abundance")


# save as CSV

write.csv(full_table_S1, "analysis/tables/meta_data_table.csv")


```